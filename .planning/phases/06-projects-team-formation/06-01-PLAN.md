---
phase: 06-projects-team-formation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/mentorship.ts
  - src/lib/validation/skillMatch.ts
  - src/lib/discord.ts
  - firestore.rules
  - package.json
autonomous: true

must_haves:
  truths:
    - "ProjectApplication and ProjectInvitation types exist and are importable"
    - "Skill mismatch detection returns appropriate warnings for level mismatches"
    - "Discord addMemberToChannel and removeMemberFromChannel functions work with existing rate limiting"
    - "Firestore security rules allow application and invitation CRUD with proper permissions"
  artifacts:
    - path: "src/types/mentorship.ts"
      provides: "ProjectApplication and ProjectInvitation interfaces"
      contains: "ProjectApplication"
    - path: "src/lib/validation/skillMatch.ts"
      provides: "detectSkillMismatch function"
      exports: ["detectSkillMismatch"]
    - path: "src/lib/discord.ts"
      provides: "addMemberToChannel, removeMemberFromChannel functions"
      contains: "addMemberToChannel"
    - path: "firestore.rules"
      provides: "Security rules for project_applications and project_invitations"
      contains: "project_applications"
  key_links:
    - from: "src/lib/validation/skillMatch.ts"
      to: "src/types/mentorship.ts"
      via: "imports ProjectDifficulty type"
      pattern: "import.*ProjectDifficulty"
    - from: "src/lib/discord.ts"
      to: "Discord REST API"
      via: "fetchWithRateLimit for permission overwrites"
      pattern: "channels.*permissions"
---

<objective>
Add foundational types, utilities, and infrastructure for the team formation system.

Purpose: Establish the data types, skill matching logic, Discord member management, and Firestore security rules needed before building application/invitation API routes.
Output: Extended type definitions, skill mismatch helper, Discord member functions, updated Firestore rules, lodash.debounce installed.
</objective>

<execution_context>
@/Users/amu1o5/.claude/get-shit-done/workflows/execute-plan.md
@/Users/amu1o5/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-projects-team-formation/06-RESEARCH.md
@src/types/mentorship.ts
@src/lib/discord.ts
@src/lib/permissions.ts
@src/lib/validation/urls.ts
@firestore.rules
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add application/invitation types and install lodash.debounce</name>
  <files>src/types/mentorship.ts, package.json</files>
  <action>
1. Install lodash.debounce: `npm install lodash.debounce && npm install --save-dev @types/lodash.debounce`

2. Add these types to `src/types/mentorship.ts` after the existing ProjectMember interface:

```typescript
export type ApplicationStatus = "pending" | "approved" | "declined";
export type InvitationStatus = "pending" | "accepted" | "declined";

export interface ProjectApplication {
  id: string; // composite: {projectId}_{userId}
  projectId: string;
  userId: string;
  userProfile?: {
    displayName: string;
    photoURL: string;
    username?: string;
  };
  message: string;
  status: ApplicationStatus;
  feedback?: string; // Feedback from creator on decline
  createdAt: Date;
  approvedAt?: Date;
  declinedAt?: Date;
}

export interface ProjectInvitation {
  id: string; // composite: {projectId}_{userId}
  projectId: string;
  userId: string;
  userProfile?: {
    displayName: string;
    photoURL: string;
    username?: string;
  };
  invitedBy: string; // creator userId
  status: InvitationStatus;
  createdAt: Date;
  acceptedAt?: Date;
  declinedAt?: Date;
}
```

Do NOT modify any existing types.
  </action>
  <verify>
- `npx tsc --noEmit` passes without errors
- `npm ls lodash.debounce` shows package installed
  </verify>
  <done>ProjectApplication and ProjectInvitation types are importable from @/types/mentorship. lodash.debounce is installed.</done>
</task>

<task type="auto">
  <name>Task 2: Create skill mismatch helper, Discord member functions, and Firestore rules</name>
  <files>src/lib/validation/skillMatch.ts, src/lib/discord.ts, firestore.rules</files>
  <action>
1. Create `src/lib/validation/skillMatch.ts` with the `detectSkillMismatch` function exactly as shown in the research (Pattern 3). It takes `userSkillLevel: ProjectDifficulty | undefined` and `projectDifficulty: ProjectDifficulty`, returns `SkillMismatch` object with `hasWarning`, `message`, and `severity` fields. Export the `SkillMismatch` interface too.

2. Extend `src/lib/discord.ts` with two new functions:

**addMemberToChannel(channelId: string, discordUsername: string): Promise&lt;boolean&gt;**
- Call existing `lookupMemberByUsername` to get Discord member ID
- If not found, log error and return false (non-blocking)
- PUT to `${DISCORD_API}/channels/${channelId}/permissions/${member.user.id}` with body: `{ type: 1, allow: "3072" }` (VIEW_CHANNEL 1024 + SEND_MESSAGES 2048)
- Use existing `fetchWithRateLimit` wrapper
- Return true on 204 status, false otherwise

**removeMemberFromChannel(channelId: string, discordUsername: string): Promise&lt;boolean&gt;**
- Call existing `lookupMemberByUsername` to get Discord member ID
- If not found, log error and return false
- DELETE to `${DISCORD_API}/channels/${channelId}/permissions/${member.user.id}`
- Use existing `fetchWithRateLimit` wrapper
- Return true on 204 status, false otherwise

Follow the exact patterns from the existing `createProjectChannel` function for headers, error handling, and logging. Use `log.debug` and `log.error` from the existing logger import.

3. Add Firestore security rules for `project_applications` and `project_invitations` collections in `firestore.rules`, after the existing `project_members` section:

```
// ─── Project Applications ────────────────────
match /project_applications/{applicationId} {
  // Any signed-in user can read applications for projects they own or applied to
  allow read: if isSignedIn() && (
    resource.data.userId == request.auth.uid ||
    get(/databases/$(database)/documents/projects/$(resource.data.projectId)).data.creatorId == request.auth.uid ||
    isAdmin()
  );

  // PERM-07: Authenticated users can create applications (not project owner - checked in API)
  allow create: if isSignedIn() &&
                   request.resource.data.userId == request.auth.uid &&
                   request.resource.data.status == "pending";

  // Only project creator or admin can update (approve/decline)
  allow update: if isSignedIn() && (
    isAdmin() ||
    get(/databases/$(database)/documents/projects/$(resource.data.projectId)).data.creatorId == request.auth.uid
  );

  // Only applicant, project creator, or admin can delete
  allow delete: if isSignedIn() && (
    resource.data.userId == request.auth.uid ||
    get(/databases/$(database)/documents/projects/$(resource.data.projectId)).data.creatorId == request.auth.uid ||
    isAdmin()
  );
}

// ─── Project Invitations ─────────────────────
match /project_invitations/{invitationId} {
  // Invited user, project creator, or admin can read
  allow read: if isSignedIn() && (
    resource.data.userId == request.auth.uid ||
    resource.data.invitedBy == request.auth.uid ||
    isAdmin()
  );

  // Only project creator or admin can create invitations
  allow create: if isSignedIn() && (
    isAdmin() ||
    get(/databases/$(database)/documents/projects/$(request.resource.data.projectId)).data.creatorId == request.auth.uid
  );

  // Invited user can update (accept/decline), creator/admin can update too
  allow update: if isSignedIn() && (
    resource.data.userId == request.auth.uid ||
    resource.data.invitedBy == request.auth.uid ||
    isAdmin()
  );

  allow delete: if isSignedIn() && (
    resource.data.userId == request.auth.uid ||
    resource.data.invitedBy == request.auth.uid ||
    isAdmin()
  );
}
```
  </action>
  <verify>
- `npx tsc --noEmit` passes
- `src/lib/validation/skillMatch.ts` exports detectSkillMismatch
- `src/lib/discord.ts` exports addMemberToChannel and removeMemberFromChannel
- `firestore.rules` contains project_applications and project_invitations sections
- `npm run build` passes
  </verify>
  <done>
- detectSkillMismatch returns warnings for beginner→advanced mismatches and info for no-skill-set users
- addMemberToChannel/removeMemberFromChannel use existing Discord patterns (fetchWithRateLimit, lookupMemberByUsername)
- Firestore rules enforce: users can create own applications, only creator/admin can approve, invited users can accept/decline
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- `npm run build` succeeds
- New types are importable: `import { ProjectApplication, ProjectInvitation } from "@/types/mentorship"`
- New functions are importable: `import { addMemberToChannel, removeMemberFromChannel } from "@/lib/discord"`
- `import { detectSkillMismatch } from "@/lib/validation/skillMatch"` works
- Firestore rules file is valid syntax
</verification>

<success_criteria>
- ProjectApplication and ProjectInvitation interfaces defined with composite key pattern
- detectSkillMismatch correctly flags beginner→advanced as warning
- Discord member management functions use existing fetchWithRateLimit and lookupMemberByUsername
- Firestore rules enforce proper access control for applications and invitations
- lodash.debounce installed for future search debouncing
- No regressions in existing code (build passes)
</success_criteria>

<output>
After completion, create `.planning/phases/06-projects-team-formation/06-01-SUMMARY.md`
</output>
