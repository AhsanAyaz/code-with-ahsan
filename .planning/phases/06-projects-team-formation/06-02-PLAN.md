---
phase: 06-projects-team-formation
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/app/api/projects/[id]/route.ts
  - src/app/api/projects/[id]/applications/route.ts
  - src/app/api/projects/[id]/applications/[userId]/route.ts
  - src/app/api/projects/[id]/invitations/route.ts
  - src/app/api/projects/[id]/invitations/[userId]/route.ts
  - src/app/api/projects/[id]/members/route.ts
  - src/app/api/projects/[id]/members/[memberId]/route.ts
autonomous: true

must_haves:
  truths:
    - "Developer can submit application to join a project via POST"
    - "Project creator can view pending applications via GET"
    - "Project creator can approve application, creating project member and adding to Discord"
    - "Project creator can decline application with optional feedback"
    - "Project creator can invite developer by email or Discord username"
    - "Invited developer receives Discord DM notification and can accept or decline invitation"
    - "Project creator can remove a team member"
    - "Submitting a duplicate application or invitation returns 409 Conflict"
    - "GET /api/projects/[id] returns single project data"
    - "GET /api/projects/[id]/members returns team roster for a project"
  artifacts:
    - path: "src/app/api/projects/[id]/applications/route.ts"
      provides: "POST (apply) and GET (list applications) endpoints"
      exports: ["POST", "GET"]
    - path: "src/app/api/projects/[id]/applications/[userId]/route.ts"
      provides: "PUT (approve/decline application) endpoint"
      exports: ["PUT"]
    - path: "src/app/api/projects/[id]/invitations/route.ts"
      provides: "POST (invite) and GET (list invitations) endpoint"
      exports: ["POST", "GET"]
    - path: "src/app/api/projects/[id]/invitations/[userId]/route.ts"
      provides: "PUT (accept/decline invitation) endpoint"
      exports: ["PUT"]
    - path: "src/app/api/projects/[id]/route.ts"
      provides: "GET (single project) endpoint added to existing file"
      exports: ["GET", "PUT"]
    - path: "src/app/api/projects/[id]/members/route.ts"
      provides: "GET (list team members) endpoint"
      exports: ["GET"]
    - path: "src/app/api/projects/[id]/members/[memberId]/route.ts"
      provides: "DELETE (remove member) endpoint"
      exports: ["DELETE"]
  key_links:
    - from: "src/app/api/projects/[id]/applications/[userId]/route.ts"
      to: "src/lib/discord.ts"
      via: "addMemberToChannel on approval"
      pattern: "addMemberToChannel"
    - from: "src/app/api/projects/[id]/applications/route.ts"
      to: "src/lib/permissions.ts"
      via: "canApplyToProject check"
      pattern: "canApplyToProject"
    - from: "src/app/api/projects/[id]/members/[memberId]/route.ts"
      to: "src/lib/discord.ts"
      via: "removeMemberFromChannel on removal"
      pattern: "removeMemberFromChannel"
    - from: "src/app/api/projects/[id]/invitations/route.ts"
      to: "src/lib/discord.ts"
      via: "sendDirectMessage on invitation creation"
      pattern: "sendDirectMessage"
---

<objective>
Build all API routes for team formation: applications (submit, list, approve, decline), invitations (create, list, accept, decline), member listing, member removal, and single project GET endpoint.

Purpose: Enable the complete team management workflow through REST API endpoints that the frontend will consume.
Output: 7 API route files (5 new + 1 extended + 1 members listing) handling the full application/invitation/member lifecycle.
</objective>

<execution_context>
@/Users/amu1o5/.claude/get-shit-done/workflows/execute-plan.md
@/Users/amu1o5/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-projects-team-formation/06-RESEARCH.md
@.planning/phases/06-projects-team-formation/06-01-SUMMARY.md
@src/app/api/projects/route.ts
@src/app/api/projects/[id]/route.ts
@src/types/mentorship.ts
@src/lib/permissions.ts
@src/lib/discord.ts
@src/lib/firebaseAdmin.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create application and invitation API routes</name>
  <files>
    src/app/api/projects/[id]/route.ts
    src/app/api/projects/[id]/applications/route.ts
    src/app/api/projects/[id]/applications/[userId]/route.ts
    src/app/api/projects/[id]/invitations/route.ts
    src/app/api/projects/[id]/invitations/[userId]/route.ts
  </files>
  <action>
Follow the patterns from the Phase 6 research exactly. All routes use Next.js 16 async params pattern: `{ params }: { params: Promise<{ id: string }> }`.

**0. GET /api/projects/[id]** (Fetch single project)
- Add a GET handler to the EXISTING `src/app/api/projects/[id]/route.ts` file (which currently only has PUT)
- Fetch project document by id from `projects` collection
- Return 404 if not found
- Return project data with `id` field included
- No auth required (public read for active projects)

**1. POST /api/projects/[id]/applications** (Developer applies to project)
- Validate required fields: userId, message
- Fetch project document, return 404 if not found
- Fetch user profile from mentorship_profiles
- Check `canApplyToProject` permission (from src/lib/permissions.ts)
- Check project status is "active" (only active projects accept applications)
- Composite key: `${projectId}_${userId}` - check existence, return 409 if duplicate
- Create application document in `project_applications` collection with denormalized userProfile
- Update project `lastActivityAt`
- Return 201 with applicationId

**2. GET /api/projects/[id]/applications** (Creator lists applications, or check user status)
- Accept query params: `status` (optional, defaults to all), `userId` (optional, filter by specific user)
- If `userId` is provided: query `project_applications` where projectId matches AND userId matches. This supports the detail page checking if the current user has already applied.
- Otherwise: query `project_applications` where projectId matches, optionally filtered by status
- Return applications array sorted by createdAt desc

**3. PUT /api/projects/[id]/applications/[userId]** (Creator approves/declines)
- Accept `{ action: "approve" | "decline", feedback?: string }` body
- Composite key: `${projectId}_${userId}` to find application
- Return 404 if not found

On **approve**:
- Use Firestore batch write for atomicity:
  1. Update application status to "approved", set approvedAt
  2. Create project_members document with composite key `${projectId}_${userId}`, role "member", denormalized userProfile
  3. Update project lastActivityAt
- After batch commit: Add to Discord channel (non-blocking) using `addMemberToChannel` if project has discordChannelId and user has discordUsername in mentorship_profiles

On **decline**:
- Update application status to "declined", set declinedAt, set feedback if provided

**4. POST /api/projects/[id]/invitations** (Creator invites by email or Discord)
- Accept `{ invitedBy, email?, discordUsername? }` - must provide email OR discordUsername
- Look up user: by email query on mentorship_profiles, or by discordUsername query
- Return 404 with helpful message if user not found ("No user found with that email. They must create a profile first.")
- Check if already a team member (project_members composite key), return 409
- Check if invitation already sent (project_invitations composite key), return 409
- Create invitation document with composite key `${projectId}_${userId}`, denormalized userProfile
- Update project lastActivityAt
- **Send Discord DM notification (non-blocking):** After creating the invitation, if the invited user has a `discordUsername` in their mentorship_profiles, call `sendDirectMessage(discordUsername, message)` from `src/lib/discord.ts` with a message like: `"You've been invited to join the project \"${projectTitle}\"! Visit ${siteUrl}/projects/${projectId} to accept or decline."` Wrap in try/catch â€” failure should be logged but not block the 201 response. Import `sendDirectMessage` from `@/lib/discord`.
- Return 201 with invitationId

**5. GET /api/projects/[id]/invitations** (List invitations)
- Query `project_invitations` where projectId matches
- Return invitations array

**6. PUT /api/projects/[id]/invitations/[userId]** (Accept/decline invitation)
- Accept `{ action: "accept" | "decline" }` body
- Composite key: `${projectId}_${userId}` to find invitation

On **accept**:
- Firestore batch write:
  1. Update invitation status to "accepted", set acceptedAt
  2. Create project_members document (same pattern as application approval)
  3. Update project lastActivityAt
- Non-blocking: Add to Discord channel

On **decline**:
- Update invitation status to "declined", set declinedAt

Follow existing API patterns from src/app/api/projects/[id]/route.ts for error handling, JSON response shapes, and import patterns. Use `db` from `@/lib/firebaseAdmin` and `FieldValue` from `firebase-admin/firestore`.
  </action>
  <verify>
- `npx tsc --noEmit` passes
- `npm run build` passes
- All 5 route files exist with correct exports (including GET added to existing [id]/route.ts)
  </verify>
  <done>
- GET /api/projects/[id] returns single project data (added to existing route.ts alongside PUT)
- POST /api/projects/[id]/applications creates application with composite key, validates canApplyToProject
- GET /api/projects/[id]/applications supports userId query param for checking current user's application status
- PUT /api/projects/[id]/applications/[userId] approve creates member + adds Discord, decline saves feedback
- POST /api/projects/[id]/invitations finds user by email/Discord, prevents duplicates, sends Discord DM notification to invited user
- PUT /api/projects/[id]/invitations/[userId] accept creates member + adds Discord
- All endpoints update lastActivityAt
  </done>
</task>

<task type="auto">
  <name>Task 2: Create member listing and member removal endpoints</name>
  <files>src/app/api/projects/[id]/members/route.ts, src/app/api/projects/[id]/members/[memberId]/route.ts</files>
  <action>
**GET /api/projects/[id]/members** (List team members)
- Create `src/app/api/projects/[id]/members/route.ts`
- Query `project_members` collection where `projectId` matches the route param `id`
- Return members array sorted by `joinedAt` asc (creator first, then members by join date)
- No auth required (team roster is public information for active projects)
- Follow Next.js 16 async params: `{ params }: { params: Promise<{ id: string }> }`

**DELETE /api/projects/[id]/members/[memberId]** (TEAM-09: Remove team member)
- `memberId` is the userId of the member to remove
- Fetch project, verify requestor is project creator or admin (use `canManageProjectMembers` from permissions.ts)
- Composite key for member document: `${projectId}_${memberId}`
- Return 404 if member not found
- Firestore batch:
  1. Delete project_members document
  2. Update project lastActivityAt
- Non-blocking: Remove from Discord channel using `removeMemberFromChannel` if project has discordChannelId and member has discordUsername
- Return 200 with success message

Follow Next.js 16 async params: `{ params }: { params: Promise<{ id: string; memberId: string }> }`
  </action>
  <verify>
- `npx tsc --noEmit` passes
- `npm run build` passes
- Route file exists at src/app/api/projects/[id]/members/route.ts with GET export
- Route file exists at src/app/api/projects/[id]/members/[memberId]/route.ts with DELETE export
  </verify>
  <done>
- GET /api/projects/[id]/members returns team roster sorted by join date
- DELETE /api/projects/[id]/members/[memberId] removes member from Firestore and Discord channel
- Permission check via canManageProjectMembers (only creator or admin)
- Non-blocking Discord removal follows existing pattern
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- `npm run build` succeeds
- All 7 route files exist and export correct HTTP methods (GET on [id]/route.ts, GET on members/route.ts, plus 5 new files)
- API patterns consistent with existing src/app/api/projects/ routes (error handling, response shapes)
</verification>

<success_criteria>
- GET /api/projects/[id] returns single project data for detail page consumption
- Complete application lifecycle: submit (POST) -> list (GET, with userId filter) -> approve/decline (PUT)
- Complete invitation lifecycle: create (POST, with Discord DM notification) -> list (GET) -> accept/decline (PUT)
- GET /api/projects/[id]/members returns team roster
- Member removal with Discord channel sync
- Invited users receive Discord DM notification with link to project (non-blocking)
- Composite keys prevent duplicate applications and invitations
- Batch writes ensure atomicity for approval/acceptance operations
- Discord operations are non-blocking (failures logged but don't block API response)
- No regressions (build passes)
</success_criteria>

<output>
After completion, create `.planning/phases/06-projects-team-formation/06-02-SUMMARY.md`
</output>
