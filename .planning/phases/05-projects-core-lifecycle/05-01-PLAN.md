---
phase: 05-projects-core-lifecycle
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/discord.ts
  - src/app/api/projects/route.ts
  - src/app/api/projects/[id]/route.ts
autonomous: true

must_haves:
  truths:
    - "POST /api/projects creates a project document in Firestore with pending status"
    - "GET /api/projects returns projects filtered by status query param"
    - "PUT /api/projects/[id] with action=approve creates Discord channel, pins project details, and sets status to active"
    - "PUT /api/projects/[id] with action=decline sets status to declined with reason"
    - "PUT /api/projects/[id] with action=complete archives Discord channel and sets status to completed"
    - "Discord channel is created in a Projects category with creator permissions"
    - "Project details message is pinned in the Discord channel"
    - "lastActivityAt is updated on every project mutation"
  artifacts:
    - path: "src/lib/discord.ts"
      provides: "createProjectChannel, archiveProjectChannel, sendProjectDetailsMessage"
      contains: "createProjectChannel"
    - path: "src/app/api/projects/route.ts"
      provides: "POST and GET endpoints for projects"
      exports: ["POST", "GET"]
    - path: "src/app/api/projects/[id]/route.ts"
      provides: "PUT endpoint for project status transitions"
      exports: ["PUT"]
  key_links:
    - from: "src/app/api/projects/[id]/route.ts"
      to: "src/lib/discord.ts"
      via: "createProjectChannel called on approve action"
      pattern: "createProjectChannel"
    - from: "src/app/api/projects/[id]/route.ts"
      to: "src/lib/discord.ts"
      via: "archiveProjectChannel called on complete action"
      pattern: "archiveProjectChannel"
    - from: "src/app/api/projects/route.ts"
      to: "src/lib/permissions.ts"
      via: "canCreateProject permission check"
      pattern: "canCreateProject"
    - from: "src/app/api/projects/[id]/route.ts"
      to: "src/lib/permissions.ts"
      via: "canApproveProject permission check"
      pattern: "canApproveProject"
---

<objective>
Build the complete backend for project lifecycle: Discord channel functions and API routes for create, list, approve, decline, and complete operations.

Purpose: This is the server-side foundation that all frontend UI depends on. It wires together Firestore, Discord, and the Phase 4 permission system into working API endpoints.

Output: Three files -- extended discord.ts with project channel management, and two API route files handling the full project lifecycle.
</objective>

<execution_context>
@/Users/amu1o5/.claude/get-shit-done/workflows/execute-plan.md
@/Users/amu1o5/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-projects-core-lifecycle/05-RESEARCH.md

@src/types/mentorship.ts
@src/lib/discord.ts
@src/lib/permissions.ts
@src/lib/validation/urls.ts
@src/app/api/mentorship/match/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add project channel functions to discord.ts</name>
  <files>src/lib/discord.ts</files>
  <action>
Add three new exported functions to src/lib/discord.ts, following the existing patterns (fetchWithRateLimit, log, getHeaders, getGuildId, ChannelResult interface):

1. `getOrCreateProjectsCategory()` (internal helper, not exported):
   - Fetch all guild channels, find categories named "Projects" or "Projects - Batch N"
   - If latest category has fewer than 45 channels (use constant MAX_CHANNELS_PER_CATEGORY = 45, conservative under Discord's 50 limit), return its ID
   - If full, create next batch category ("Projects - Batch 2", etc.)
   - If no category exists, create "Projects" category (type 4)
   - Follow the exact same pattern as the existing mentorship monthly category logic (getOrCreateMonthlyCategory if it exists, otherwise replicate the pattern from createMentorshipChannel)

2. `createProjectChannel(projectTitle, creatorName, projectId, creatorDiscordUsername?)`:
   - Returns Promise<ChannelResult | null>
   - Get category ID from getOrCreateProjectsCategory()
   - Sanitize channel name: `proj-${title.toLowerCase().replace(/[^a-z0-9]/g, '-').slice(0, 50)}`
   - Create text channel (type 0) with permission_overwrites:
     * @everyone (guild ID, type 0): deny VIEW_CHANNEL ("1024")
     * Creator (if found via lookupMemberByUsername, type 1): allow VIEW_CHANNEL + SEND_MESSAGES ("3072")
   - Set topic: `Project: ${projectTitle} | Creator: ${creatorName} | ID: ${projectId}`
   - Send welcome message using sendChannelMessage (already exported)
   - Return { channelId, channelUrl }

3. `sendProjectDetailsMessage(channelId, project: { title, description, githubRepo?, techStack, difficulty })`:
   - Returns Promise<boolean>
   - Format details message with title, description, tech stack, difficulty, GitHub link
   - Send message to channel using Discord API directly (POST /channels/{id}/messages)
   - Pin the message (PUT /channels/{id}/pins/{messageId})
   - Return true on success

4. `archiveProjectChannel(channelId, projectTitle)`:
   - Returns Promise<boolean>
   - Reuse existing archiveMentorshipChannel function, passing a project-specific archive message
   - Message: "Project '{projectTitle}' has been completed! This channel is now archived."

IMPORTANT: Do NOT use emojis in any code strings or messages. Use plain text only.
Do NOT duplicate existing helper functions (fetchWithRateLimit, sendChannelMessage, lookupMemberByUsername). Import/call them directly since they're in the same file.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no TypeScript errors.
Grep for "createProjectChannel" and "archiveProjectChannel" and "sendProjectDetailsMessage" in discord.ts to confirm exports exist.
  </verify>
  <done>
discord.ts exports createProjectChannel, archiveProjectChannel, and sendProjectDetailsMessage. All functions use existing rate-limited fetch, logging, and channel management patterns. TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create project API routes</name>
  <files>src/app/api/projects/route.ts, src/app/api/projects/[id]/route.ts</files>
  <action>
Create two API route files following the pattern in src/app/api/mentorship/ routes:

**File 1: src/app/api/projects/route.ts** (POST + GET)

POST handler (create project):
- Parse JSON body: { title, description, githubRepo?, techStack, difficulty, maxTeamSize, creatorId }
- Validate required fields: title (string, 3-100 chars), description (string, 10-2000 chars), creatorId (string)
- If githubRepo provided, validate with validateGitHubUrl from @/lib/validation/urls
- Fetch creator's mentorship_profiles doc from Firestore
- Check canCreateProject permission from @/lib/permissions (requires accepted mentor)
- Create project document in "projects" collection with:
  * All provided fields
  * status: "pending"
  * creatorProfile: { displayName, photoURL, username } denormalized from creator's profile
  * lastActivityAt: FieldValue.serverTimestamp()
  * createdAt: FieldValue.serverTimestamp()
  * updatedAt: FieldValue.serverTimestamp()
  * techStack: array (default [])
  * difficulty: default "intermediate"
  * maxTeamSize: default 4
- Return 201 with { success: true, projectId }
- Return 400 for validation errors, 403 for permission errors, 404 if creator not found, 500 for server errors

GET handler (list projects):
- Accept query params: status (optional, filters by project status), creatorId (optional, filters by creator)
- Query "projects" collection with appropriate where clauses
- Order by createdAt desc
- Convert Firestore Timestamps to ISO strings for JSON serialization
- Return 200 with { projects: Project[] }

**File 2: src/app/api/projects/[id]/route.ts** (PUT)

PUT handler (status transitions):
- Parse route param `id` using `{ params }: { params: Promise<{ id: string }> }` pattern (Next.js 16 async params)
- Parse JSON body: { action, adminId?, creatorId?, declineReason? }
- Fetch project document, return 404 if not found
- Handle three actions:

action === "approve":
  - Require adminId in body
  - Fetch admin's mentorship_profiles doc
  - Check canApproveProject permission (requires admin)
  - Update project: status "active", approvedAt, approvedBy, updatedAt, lastActivityAt (all serverTimestamp)
  - Call createProjectChannel(title, creatorProfile.displayName, id, creatorProfile discordUsername if available -- fetch full creator profile for discordUsername)
  - If channel created successfully, update project with discordChannelId and discordChannelUrl
  - Call sendProjectDetailsMessage with channel ID and project details (title, description, githubRepo, techStack, difficulty) to pin project info
  - Return 200 with { success: true, message, discordChannelId?, discordChannelUrl? }
  - If Discord fails, project still moves to active (log error, don't fail the request)

action === "decline":
  - Require adminId in body
  - Check canApproveProject permission (same permission covers approve and decline)
  - Update project: status "declined", declineReason (from body), updatedAt, lastActivityAt
  - Return 200 with { success: true, message }

action === "complete":
  - Require creatorId in body
  - Verify creatorId matches project.creatorId (only creator can complete)
  - Update project: status "completed", updatedAt, lastActivityAt, completedAt: serverTimestamp
  - If project has discordChannelId, call archiveProjectChannel(channelId, title)
  - Return 200 with { success: true, message }

For ALL actions, return 400 for invalid action, 403 for permission errors, 404 for project not found.

Import firebase-admin/firestore for FieldValue. Import db from @/lib/firebaseAdmin. Import permission functions from @/lib/permissions. Import Discord functions from @/lib/discord. Import validateGitHubUrl from @/lib/validation/urls.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no TypeScript errors.
Verify both route files exist and export the correct HTTP method handlers.
Check that the API routes import from permissions.ts and discord.ts correctly.
  </verify>
  <done>
POST /api/projects creates projects with validation and permission checks. GET /api/projects lists projects with status/creator filters. PUT /api/projects/[id] handles approve (with Discord channel + pinned message), decline (with reason), and complete (with Discord archive) actions. All endpoints use FieldValue.serverTimestamp() for lastActivityAt tracking. TypeScript compiles cleanly.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `grep -r "createProjectChannel\|archiveProjectChannel\|sendProjectDetailsMessage" src/lib/discord.ts` shows all three functions
3. `grep -r "export async function POST\|export async function GET" src/app/api/projects/route.ts` shows both handlers
4. `grep -r "export async function PUT" src/app/api/projects/\[id\]/route.ts` shows PUT handler
5. `grep -r "canCreateProject\|canApproveProject" src/app/api/projects/` shows permission checks are wired
6. `grep -r "lastActivityAt" src/app/api/projects/` shows activity tracking on all mutations
</verification>

<success_criteria>
- Three new Discord functions exported from discord.ts (createProjectChannel, archiveProjectChannel, sendProjectDetailsMessage)
- POST /api/projects creates project with pending status, denormalized creator profile, and lastActivityAt
- GET /api/projects lists projects with optional status and creatorId filters
- PUT /api/projects/[id] handles approve (Discord channel + pin), decline (with reason), and complete (Discord archive)
- All endpoints use Phase 4 permission system (canCreateProject, canApproveProject)
- All mutations update lastActivityAt via FieldValue.serverTimestamp()
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-projects-core-lifecycle/05-01-SUMMARY.md`
</output>
