---
phase: 11-admin-project-management-view-all-projects-and-delete-with-cascade-cleanup
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/admin/projects/route.ts
  - src/app/api/admin/projects/[id]/route.ts
  - src/lib/discord.ts
autonomous: true

must_haves:
  truths:
    - "GET /api/admin/projects returns all projects with enriched data (member counts, application counts, invitation counts)"
    - "GET /api/admin/projects supports status, search, and date range filtering"
    - "DELETE /api/admin/projects/[id] deletes project and all related data atomically"
    - "Delete operation removes Discord channel before committing Firestore batch"
    - "Delete operation sends DMs to all affected members (non-blocking)"
    - "Delete requires admin authentication and a reason string"
    - "Delete returns detailed summary of what was cleaned up"
    - "Firestore batch handles >500 document limit with multiple batches"
  artifacts:
    - path: "src/app/api/admin/projects/route.ts"
      provides: "GET endpoint for admin project listing with enriched data and filters"
      exports: ["GET"]
    - path: "src/app/api/admin/projects/[id]/route.ts"
      provides: "DELETE endpoint for cascade project deletion"
      exports: ["DELETE"]
    - path: "src/lib/discord.ts"
      provides: "deleteDiscordChannel helper function"
      contains: "deleteDiscordChannel"
  key_links:
    - from: "src/app/api/admin/projects/[id]/route.ts"
      to: "src/lib/discord.ts"
      via: "import deleteDiscordChannel, sendDirectMessage"
      pattern: "deleteDiscordChannel|sendDirectMessage"
    - from: "src/app/api/admin/projects/[id]/route.ts"
      to: "firebase-admin/firestore"
      via: "batch writes for atomic multi-collection delete"
      pattern: "db\\.batch\\(\\)|batch\\.delete|batch\\.commit"
    - from: "src/app/api/admin/projects/route.ts"
      to: "src/lib/auth.ts"
      via: "verifyAuth for admin authentication"
      pattern: "verifyAuth"
---

<objective>
Create the backend API endpoints for admin project management: an enriched project listing endpoint and an atomic cascade delete endpoint.

Purpose: The listing endpoint provides comprehensive project data with member/application/invitation counts for the admin view. The delete endpoint implements the all-or-nothing cascade cleanup across Firestore collections and Discord.

Output: Two API route files providing admin-level project operations.
</objective>

<execution_context>
@/Users/amu1o5/.claude/get-shit-done/workflows/execute-plan.md
@/Users/amu1o5/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-admin-project-management-view-all-projects-and-delete-with-cascade-cleanup/11-CONTEXT.md
@.planning/phases/11-admin-project-management-view-all-projects-and-delete-with-cascade-cleanup/11-RESEARCH.md
@src/app/api/projects/route.ts
@src/app/api/projects/[id]/route.ts
@src/lib/auth.ts
@src/lib/discord.ts
@src/lib/firebaseAdmin.ts
@src/types/mentorship.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin projects listing API with enriched data and filtering</name>
  <files>
    src/app/api/admin/projects/route.ts
  </files>
  <action>
Create `GET /api/admin/projects` endpoint that returns all projects with comprehensive metadata for admin management. This is separate from the existing `/api/projects` endpoint because admin needs enriched data (member counts, application counts, invitation counts) that regular users don't need.

**Authentication:** Use `verifyAuth(request)` from `@/lib/auth` to verify Firebase ID token. Then check admin status: fetch the user's `mentorship_profiles` doc and verify `isAdmin === true`. Return 403 if not admin. (This follows the pattern used in existing admin endpoints where admin status is checked server-side.)

**Query Parameters:**
- `status` (optional): Filter by project status ("pending", "active", "completed", "declined")
- `search` (optional): Text search across project title and description (case-insensitive, client-side filter after Firestore query since Firestore lacks full-text search)
- `fromDate` (optional): ISO date string, filter projects created on or after this date
- `toDate` (optional): ISO date string, filter projects created on or before this date

**Implementation:**
1. Build Firestore query on `projects` collection, ordered by `createdAt` desc
2. Apply `status` filter via Firestore `.where()` if provided
3. Execute query and get all project docs
4. For each project, query counts in parallel using `Promise.all`:
   - `project_members` where `projectId == projectId` -> `memberCount`
   - `project_applications` where `projectId == projectId` -> `applicationCount`
   - `project_invitations` where `projectId == projectId` -> `invitationCount`

   Optimization: batch the count queries. For N projects, fire 3*N queries in parallel. This is acceptable for admin use (not public-facing, typically <100 projects).

5. Apply client-side text search filter if `search` param present (filter by title/description case-insensitive includes)
6. Apply client-side date range filters if `fromDate`/`toDate` present (compare `createdAt` against date boundaries)
7. Convert all Firestore Timestamps to ISO strings
8. Return response:
```json
{
  "projects": [
    {
      "id": "...",
      "title": "...",
      "description": "...",
      "status": "active",
      "creatorId": "...",
      "creatorProfile": { "displayName": "...", "photoURL": "...", "username": "...", "discordUsername": "..." },
      "techStack": ["React", "Node.js"],
      "difficulty": "intermediate",
      "maxTeamSize": 4,
      "memberCount": 3,
      "applicationCount": 5,
      "invitationCount": 2,
      "githubRepo": "...",
      "discordChannelId": "...",
      "discordChannelUrl": "...",
      "demoUrl": "...",
      "demoDescription": "...",
      "createdAt": "2026-02-10T...",
      "updatedAt": "2026-02-10T...",
      "approvedAt": "2026-02-10T...",
      "lastActivityAt": "2026-02-10T...",
      "completedAt": "2026-02-10T..."
    }
  ],
  "total": 42
}
```

IMPORTANT: Do NOT use Firestore composite index for date range + status filter - those require pre-created indexes. Instead, apply status filter via Firestore `.where()` (single-field, auto-indexed) and apply date filters client-side after fetching. This avoids needing to deploy new Firestore indexes.
  </action>
  <verify>
- `npx next build` succeeds
- `curl` or test: `GET /api/admin/projects` returns all projects with memberCount, applicationCount, invitationCount fields
- `GET /api/admin/projects?status=active` returns only active projects
- `GET /api/admin/projects?search=react` returns projects with "react" in title or description
- Non-admin user gets 403 response
  </verify>
  <done>
- `/api/admin/projects` GET endpoint exists and returns enriched project data
- Filtering by status, search, and date range works
- Admin authentication enforced (403 for non-admins)
- Response includes memberCount, applicationCount, invitationCount per project
  </done>
</task>

<task type="auto">
  <name>Task 2: Create cascade delete API endpoint with Discord cleanup and DM notifications</name>
  <files>
    src/app/api/admin/projects/[id]/route.ts
    src/lib/discord.ts
  </files>
  <action>
**Add `deleteDiscordChannel` to `src/lib/discord.ts`:**

Add a new exported function to the existing discord.ts file:
```typescript
export async function deleteDiscordChannel(channelId: string, reason: string): Promise<boolean> {
  // Use existing fetchWithRateLimit and getHeaders helpers (already in discord.ts)
  // DELETE https://discord.com/api/v10/channels/{channelId}
  // Add X-Audit-Log-Reason header with the reason
  // Return true if deleted (200) or already gone (404)
  // Return false on other errors
  // Log all outcomes
}
```
Follow the same error handling pattern as `getChannel()` and `archiveProjectChannel()` in the existing file.

**Create `DELETE /api/admin/projects/[id]` endpoint:**

Implements the atomic cascade delete with the following phases:

**Phase 1: Authentication and Validation**
- `verifyAuth(request)` for Firebase token
- Check admin status via `mentorship_profiles` doc (`isAdmin === true`)
- Parse request body: `{ reason: string }` - require reason, minimum 10 characters
- Fetch project doc - return 404 if not found

**Phase 2: Gather Related Data**
Query all related collections in parallel:
```typescript
const [membersSnap, applicationsSnap, invitationsSnap] = await Promise.all([
  db.collection('project_members').where('projectId', '==', projectId).get(),
  db.collection('project_applications').where('projectId', '==', projectId).get(),
  db.collection('project_invitations').where('projectId', '==', projectId).get(),
]);
```
Extract member data for notifications (need userProfile.discordUsername from each member doc).
Also include the project creator (from project.creatorProfile.discordUsername) as someone to notify.

**Phase 3: Discord Channel Deletion (validate first, fail fast)**
- If project has `discordChannelId`:
  - Call `getChannel(discordChannelId)` to check existence
  - If channel exists, call `deleteDiscordChannel(discordChannelId, reason)`
  - If deletion returns false (error, not 404), return 500: "Failed to delete Discord channel. Cannot proceed with atomic deletion."
  - If channel already gone (404 from getChannel), treat as success
- If no discordChannelId, skip this phase

**Phase 4: Firestore Atomic Batch Delete**
Handle the 500-document Firestore batch limit:
```typescript
const MAX_BATCH_SIZE = 500;
const allDocs = [
  projectDoc.ref,
  ...membersSnap.docs.map(d => d.ref),
  ...applicationsSnap.docs.map(d => d.ref),
  ...invitationsSnap.docs.map(d => d.ref),
];

// Split into batches of 500
for (let i = 0; i < allDocs.length; i += MAX_BATCH_SIZE) {
  const batch = db.batch();
  const chunk = allDocs.slice(i, i + MAX_BATCH_SIZE);
  chunk.forEach(ref => batch.delete(ref));
  await batch.commit();
}
```
NOTE: If using multiple batches, the operation is NOT fully atomic across batches. This is acceptable because:
1. Projects with >500 related docs are extremely unlikely (max team ~10, applications ~50, invitations ~50 = ~111 docs total)
2. The first batch deletes the project doc itself, so even if a later batch fails, the project is gone and orphaned data can be cleaned up later

**Phase 5: Notifications (non-blocking, best-effort)**
Send Discord DMs to all affected users:
- Collect all unique Discord usernames from: members (userProfile.discordUsername), creator (creatorProfile.discordUsername)
- Message template:
  ```
  **Project Deleted by Administrator**

  The project "{project.title}" has been deleted by an admin.

  **Reason:** {reason}

  If you have questions, please contact the community moderators.
  ```
- Use `Promise.allSettled()` to send all DMs (don't fail if some DMs fail)
- Use existing `sendDirectMessage(discordUsername, message)` from discord.ts
- Log successes and failures

**Phase 6: Response**
Return detailed summary:
```json
{
  "success": true,
  "message": "Project and all related data deleted successfully",
  "summary": {
    "projectTitle": "My Project",
    "membersRemoved": 3,
    "applicationsDeleted": 5,
    "invitationsDeleted": 2,
    "discordChannelDeleted": true,
    "membersNotified": 3,
    "notificationsFailed": 0
  }
}
```

**Error responses:**
- 401: Not authenticated
- 403: Not admin
- 400: Missing or too-short reason (min 10 chars)
- 404: Project not found
- 500: Discord channel deletion failed / Firestore batch failed
  </action>
  <verify>
- `npx next build` succeeds
- `deleteDiscordChannel` function exists in discord.ts
- DELETE endpoint validates admin auth, requires reason, returns 400/401/403/404 appropriately
- Test with non-existent project returns 404
- Response includes detailed summary with counts
  </verify>
  <done>
- `DELETE /api/admin/projects/[id]` endpoint handles full cascade deletion
- Discord channel deleted before Firestore commit (fail-fast pattern)
- Firestore batch handles >500 docs with chunked batches
- All members receive Discord DM notification (best-effort)
- Deletion reason required (min 10 chars) for audit trail
- Response returns detailed cleanup summary
- `deleteDiscordChannel` helper added to discord.ts
  </done>
</task>

</tasks>

<verification>
1. Build passes: `npx next build` completes without errors
2. GET /api/admin/projects returns enriched project data with counts
3. GET /api/admin/projects?status=active filters correctly
4. DELETE /api/admin/projects/[id] with valid admin token + reason succeeds
5. DELETE without reason returns 400
6. DELETE by non-admin returns 403
7. DELETE returns summary with member/application/invitation counts
</verification>

<success_criteria>
- Admin project listing API returns all projects with memberCount, applicationCount, invitationCount
- Cascade delete API atomically removes project + members + applications + invitations
- Discord channel deleted before database commit (all-or-nothing pattern)
- All affected members notified via Discord DM with admin's reason
- Both endpoints enforce admin authentication
</success_criteria>

<output>
After completion, create `.planning/phases/11-admin-project-management-view-all-projects-and-delete-with-cascade-cleanup/11-02-SUMMARY.md`
</output>
