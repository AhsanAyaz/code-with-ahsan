---
phase: 01-mentorship-mapping-view
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/mentorship/admin/matches/route.ts
autonomous: true

must_haves:
  truths:
    - "API returns mentorship matches grouped by mentor or mentee"
    - "Each match includes partner profile details (avatar, name, email, Discord)"
    - "Matches include status, Discord channel link, start date, last activity"
  artifacts:
    - path: "src/app/api/mentorship/admin/matches/route.ts"
      provides: "GET endpoint for mentorship matches with grouping"
      exports: ["GET"]
  key_links:
    - from: "src/app/api/mentorship/admin/matches/route.ts"
      to: "mentorship_matches collection"
      via: "Firestore query"
      pattern: "db.collection\\('mentorship_matches'\\)"
    - from: "src/app/api/mentorship/admin/matches/route.ts"
      to: "mentorship_profiles collection"
      via: "Batch profile lookup"
      pattern: "where\\('uid', 'in'"
---

<objective>
Create API endpoint to fetch mentorship matches with joined mentor/mentee profile data.

Purpose: The UI needs grouped mentorship data with full profile details to display relationships. This endpoint fetches matches from Firestore and joins them with profile data, avoiding N+1 queries by batch-fetching profiles.

Output: Working `/api/mentorship/admin/matches` endpoint that returns matches grouped by mentor (for All Mentors tab) or mentee (for All Mentees tab).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-mentorship-mapping-view/01-CONTEXT.md
@.planning/phases/01-mentorship-mapping-view/01-RESEARCH.md

# Existing patterns to follow
@src/app/api/mentorship/admin/profiles/route.ts
@src/types/mentorship.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create matches API endpoint with profile joins</name>
  <files>src/app/api/mentorship/admin/matches/route.ts</files>
  <action>
Create GET endpoint at `/api/mentorship/admin/matches` that:

1. Accepts query param `role` ('mentor' | 'mentee') to determine grouping
2. Fetches all matches from `mentorship_matches` collection with status in ['active', 'completed', 'pending', 'cancelled']
3. Extracts unique mentorId and menteeId values from matches
4. Batch-fetches profiles from `mentorship_profiles` collection in chunks of 30 (Firestore 'in' query limit)
5. Builds lookup maps for mentor and mentee profiles
6. Joins profile data onto each match
7. Groups matches by mentor (if role='mentor') or by mentee (if role='mentee')
8. Returns JSON with structure:
   ```
   {
     matches: [
       {
         profile: { uid, displayName, email, photoURL, discordUsername, ... },
         mentorships: [
           {
             id, status, discordChannelId, discordChannelUrl,
             approvedAt, lastContactAt, requestedAt,
             partnerProfile: { uid, displayName, email, photoURL, discordUsername, ... }
           }
         ]
       }
     ],
     summary: {
       totalMentors, totalMentees, activeMentorships, completedMentorships
     }
   }
   ```

Follow existing pattern from profiles/route.ts:
- Use `db` from '@/lib/firebaseAdmin'
- Convert Firestore timestamps to ISO strings
- Return 500 with error message on failure

Helper function `chunkArray(arr, size)` to split arrays for batch queries.
  </action>
  <verify>
Run `curl http://localhost:3000/api/mentorship/admin/matches?role=mentor` and verify:
- Returns 200 status
- Response has `matches` array and `summary` object
- Each match has `profile` and `mentorships` array
- Each mentorship has `partnerProfile` with profile details
  </verify>
  <done>
API endpoint returns grouped mentorship data with full profile details for both mentor and mentee roles
  </done>
</task>

<task type="auto">
  <name>Task 2: Add mentors with no mentees to response</name>
  <files>src/app/api/mentorship/admin/matches/route.ts</files>
  <action>
Enhance the endpoint to include mentors/mentees who have NO matches:

1. After grouping matches, fetch ALL profiles with the requested role from `mentorship_profiles`
2. For profiles that have no matches (not in grouped data), add them with empty `mentorships: []`
3. This ensures the All Mentors tab shows ALL mentors including those with 0 mentees

The CONTEXT.md decision states: "Show all mentors/mentees including those with no relationships (indicate '0 mentees' or '0 mentors')"

Update return structure to include these zero-match profiles at the end of the matches array.
  </action>
  <verify>
Create a test mentor profile with no matches (or use existing one if available).
Run `curl http://localhost:3000/api/mentorship/admin/matches?role=mentor` and verify:
- Response includes mentors with `mentorships: []`
- Summary counts are accurate
  </verify>
  <done>
All mentors appear in response including those with zero mentees, all mentees appear including those with zero mentors
  </done>
</task>

</tasks>

<verification>
1. API endpoint exists at `/api/mentorship/admin/matches`
2. `role=mentor` returns mentors grouped with their mentees
3. `role=mentee` returns mentees grouped with their mentors
4. Mentors/mentees with no matches are included
5. Profile data (displayName, email, photoURL, discordUsername) is present
6. Mentorship data (status, discordChannelUrl, dates) is present
7. Summary stats are accurate
</verification>

<success_criteria>
- GET `/api/mentorship/admin/matches?role=mentor` returns all mentors with their mentorships
- GET `/api/mentorship/admin/matches?role=mentee` returns all mentees with their mentorships
- Response includes joined profile data (no N+1 queries)
- Response includes summary stats for UI header
- Mentors/mentees with zero relationships are included
</success_criteria>

<output>
After completion, create `.planning/phases/01-mentorship-mapping-view/01-01-SUMMARY.md`
</output>
