---
phase: 02-discord-status-management
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/app/mentorship/admin/page.tsx
autonomous: false

must_haves:
  truths:
    - "Admin can click on a Discord username field and edit it inline"
    - "Admin can click a button to mark an active mentorship as completed"
    - "Admin can click a button to revert a completed mentorship to active"
    - "Admin can click delete button and confirm to remove a mentorship"
    - "Admin can paste a new Discord channel URL to update it"
    - "All changes reflect immediately in the UI without page refresh"
  artifacts:
    - path: "src/app/mentorship/admin/page.tsx"
      provides: "Inline Discord edit, status buttons, delete modal, channel URL update"
      min_lines: 1900
  key_links:
    - from: "src/app/mentorship/admin/page.tsx"
      to: "/api/mentorship/admin/profiles"
      via: "fetch PUT for Discord username"
      pattern: "fetch.*api/mentorship/admin/profiles.*PUT"
    - from: "src/app/mentorship/admin/page.tsx"
      to: "/api/mentorship/admin/sessions"
      via: "fetch PUT for status, DELETE for removal"
      pattern: "fetch.*api/mentorship/admin/sessions"
---

<objective>
Add admin UI for Discord username editing, mentorship status management, and deletion.

Purpose: Enable administrators to manage Discord usernames (for mentors and mentees), update Discord channel URLs, change mentorship status (complete/revert), and delete mentorships directly from the dashboard without database access.

Output: Enhanced admin page with inline Discord editing, status action buttons, delete confirmation modal, and Discord channel URL update capability.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-discord-status-management/02-RESEARCH.md
@.planning/phases/02-discord-status-management/02-01-SUMMARY.md

# Main file to modify
@src/app/mentorship/admin/page.tsx

# API patterns from plan 01
@src/app/api/mentorship/admin/profiles/route.ts
@src/app/api/mentorship/admin/sessions/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add inline Discord username editing to mentor/mentee cards</name>
  <files>src/app/mentorship/admin/page.tsx</files>
  <action>
Add inline editing capability for Discord usernames in the mentor and mentee cards:

**1. Add state for tracking edit mode:**
```typescript
const [editingDiscord, setEditingDiscord] = useState<string | null>(null) // uid of profile being edited
const [editingDiscordValue, setEditingDiscordValue] = useState("")
const [savingDiscord, setSavingDiscord] = useState(false)
```

**2. Create handleDiscordSave function:**
```typescript
const handleDiscordSave = async (uid: string, newUsername: string) => {
  // Validate format client-side first
  if (newUsername && !/^[a-z0-9_.]{2,32}$/.test(newUsername)) {
    toast.error("Invalid Discord username format. Use 2-32 lowercase characters (letters, numbers, underscore, period).")
    return
  }

  setSavingDiscord(true)
  try {
    const response = await fetch("/api/mentorship/admin/profiles", {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ uid, discordUsername: newUsername })
    })

    if (!response.ok) {
      const data = await response.json()
      throw new Error(data.error || "Update failed")
    }

    // Update local state - find and update the profile in mentorshipData
    setMentorshipData(prev => prev.map(group => ({
      ...group,
      profile: group.profile.uid === uid
        ? { ...group.profile, discordUsername: newUsername }
        : group.profile,
      mentorships: group.mentorships.map(m => ({
        ...m,
        partnerProfile: m.partnerProfile?.uid === uid
          ? { ...m.partnerProfile, discordUsername: newUsername }
          : m.partnerProfile
      }))
    })))

    toast.success("Discord username updated")
    setEditingDiscord(null)
  } catch (error) {
    toast.error(error instanceof Error ? error.message : "Failed to update Discord username")
  } finally {
    setSavingDiscord(false)
  }
}
```

**3. Create InlineDiscordEdit component (inline in the file or as a helper):**
Display current Discord username with edit icon. On click, switch to input mode. On blur/Enter, save. On Escape, cancel.

```tsx
// In the profile card section where discordUsername is displayed
{editingDiscord === profile.uid ? (
  <input
    type="text"
    className="input input-bordered input-xs w-40"
    value={editingDiscordValue}
    onChange={(e) => setEditingDiscordValue(e.target.value.toLowerCase())}
    onBlur={() => {
      if (editingDiscordValue !== profile.discordUsername) {
        handleDiscordSave(profile.uid, editingDiscordValue)
      } else {
        setEditingDiscord(null)
      }
    }}
    onKeyDown={(e) => {
      if (e.key === "Enter") {
        handleDiscordSave(profile.uid, editingDiscordValue)
      } else if (e.key === "Escape") {
        setEditingDiscord(null)
      }
    }}
    autoFocus
    disabled={savingDiscord}
    placeholder="username"
  />
) : (
  <span
    className="cursor-pointer hover:bg-base-200 rounded px-1"
    onClick={() => {
      setEditingDiscord(profile.uid)
      setEditingDiscordValue(profile.discordUsername || "")
    }}
    title="Click to edit Discord username"
  >
    {profile.discordUsername || <span className="text-base-content/50 italic">No Discord</span>}
    <span className="ml-1 text-xs opacity-50">✏️</span>
  </span>
)}
```

**4. Apply this pattern in both places:**
- Main profile card (the mentor or mentee whose card is expanded)
- Partner profile display (within each mentorship row)

Look for where `discordUsername` is currently displayed and wrap with the inline edit pattern.
  </action>
  <verify>
1. Start dev server: `npm run dev`
2. Navigate to admin dashboard, go to All Mentors or All Mentees tab
3. Find a mentor/mentee card showing a Discord username
4. Click on the Discord username - should show input field
5. Type a new valid username, press Enter - should save and show toast
6. Try invalid format (uppercase) - should show error toast without saving
7. Press Escape while editing - should cancel without saving
8. Edit a partner's Discord username within a mentorship row - should also work
  </verify>
  <done>
- Discord usernames are editable inline with click-to-edit pattern
- Input validates format and shows error for invalid usernames
- Changes persist to Firestore and update UI immediately
- Works for both main profile and partner profiles in mentorship rows
- Escape cancels edit, Enter/blur saves
  </done>
</task>

<task type="auto">
  <name>Task 2: Add mentorship status management and deletion UI</name>
  <files>src/app/mentorship/admin/page.tsx</files>
  <action>
Add status action buttons and delete functionality to each mentorship row:

**1. Add state for tracking operations:**
```typescript
const [updatingStatus, setUpdatingStatus] = useState<string | null>(null) // sessionId being updated
const [deletingSession, setDeletingSession] = useState<string | null>(null) // sessionId being deleted
const [showDeleteModal, setShowDeleteModal] = useState(false)
const [sessionToDelete, setSessionToDelete] = useState<{id: string, partnerName: string} | null>(null)
```

**2. Create handleStatusChange function:**
```typescript
const handleStatusChange = async (sessionId: string, newStatus: string) => {
  setUpdatingStatus(sessionId)
  try {
    const response = await fetch("/api/mentorship/admin/sessions", {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ sessionId, status: newStatus })
    })

    if (!response.ok) {
      const data = await response.json()
      throw new Error(data.error || "Status update failed")
    }

    // Update local state - update the mentorship status in mentorshipData
    setMentorshipData(prev => prev.map(group => ({
      ...group,
      mentorships: group.mentorships.map(m =>
        m.id === sessionId ? { ...m, status: newStatus } : m
      )
    })))

    toast.success(`Mentorship marked as ${newStatus}`)
  } catch (error) {
    toast.error(error instanceof Error ? error.message : "Failed to update status")
  } finally {
    setUpdatingStatus(null)
  }
}
```

**3. Create handleDeleteMentorship function:**
```typescript
const handleDeleteMentorship = async () => {
  if (!sessionToDelete) return

  setDeletingSession(sessionToDelete.id)
  try {
    const response = await fetch(`/api/mentorship/admin/sessions?id=${sessionToDelete.id}`, {
      method: "DELETE"
    })

    if (!response.ok) {
      const data = await response.json()
      throw new Error(data.error || "Delete failed")
    }

    // Remove from local state
    setMentorshipData(prev => prev.map(group => ({
      ...group,
      mentorships: group.mentorships.filter(m => m.id !== sessionToDelete.id)
    })))

    toast.success("Mentorship deleted")
    setShowDeleteModal(false)
    setSessionToDelete(null)
  } catch (error) {
    toast.error(error instanceof Error ? error.message : "Failed to delete mentorship")
  } finally {
    setDeletingSession(null)
  }
}
```

**4. Add action buttons to each mentorship row:**
In the mentorship card/row (where status badge is shown), add action buttons based on current status:

```tsx
{/* Action buttons - show based on current status */}
<div className="flex gap-1 ml-auto">
  {mentorship.status === "active" && (
    <button
      className="btn btn-xs btn-success"
      onClick={() => handleStatusChange(mentorship.id, "completed")}
      disabled={updatingStatus === mentorship.id}
    >
      {updatingStatus === mentorship.id ? "..." : "Complete"}
    </button>
  )}
  {mentorship.status === "completed" && (
    <button
      className="btn btn-xs btn-warning"
      onClick={() => handleStatusChange(mentorship.id, "active")}
      disabled={updatingStatus === mentorship.id}
    >
      {updatingStatus === mentorship.id ? "..." : "Revert"}
    </button>
  )}
  <button
    className="btn btn-xs btn-error btn-outline"
    onClick={() => {
      setSessionToDelete({
        id: mentorship.id,
        partnerName: mentorship.partnerProfile?.displayName || "Unknown"
      })
      setShowDeleteModal(true)
    }}
    disabled={deletingSession === mentorship.id}
  >
    Delete
  </button>
</div>
```

**5. Add delete confirmation modal (at end of component, before closing fragment/div):**
```tsx
{/* Delete Confirmation Modal */}
{showDeleteModal && sessionToDelete && (
  <dialog className="modal modal-open">
    <div className="modal-box">
      <h3 className="font-bold text-lg">Delete Mentorship?</h3>
      <p className="py-4">
        Are you sure you want to delete the mentorship with <strong>{sessionToDelete.partnerName}</strong>?
        This action cannot be undone.
      </p>
      <div className="modal-action">
        <button
          className="btn btn-ghost"
          onClick={() => {
            setShowDeleteModal(false)
            setSessionToDelete(null)
          }}
        >
          Cancel
        </button>
        <button
          className="btn btn-error"
          onClick={handleDeleteMentorship}
          disabled={deletingSession === sessionToDelete.id}
        >
          {deletingSession === sessionToDelete.id ? "Deleting..." : "Delete"}
        </button>
      </div>
    </div>
    <form method="dialog" className="modal-backdrop">
      <button onClick={() => {
        setShowDeleteModal(false)
        setSessionToDelete(null)
      }}>close</button>
    </form>
  </dialog>
)}
```

**6. Add Discord channel URL update (inline edit):**
Add state:
```typescript
const [editingChannel, setEditingChannel] = useState<string | null>(null) // sessionId
const [editingChannelValue, setEditingChannelValue] = useState("")
```

Create handler (updates directly in mentorship_sessions, use a dedicated API or extend sessions API):
For simplicity, add a PUT handler that accepts discordChannelUrl. Or create inline update using existing matches API.

Since the sessions API (02-01) doesn't include channel URL update, add it now:
- Extend the PUT handler in sessions/route.ts to accept optional discordChannelUrl
- If only discordChannelUrl is provided (no status), just update that field

Show editable Discord channel link similar to Discord username pattern. When edited, call the sessions API with new URL.
  </action>
  <verify>
1. Start dev server: `npm run dev`
2. Navigate to admin dashboard, go to All Mentors tab
3. Expand a mentor card to see their mentorships
4. For an ACTIVE mentorship:
   - Click "Complete" button - should update status to completed, move to Completed section
5. For a COMPLETED mentorship:
   - Click "Revert" button - should update status to active, move back to Active section
6. For any mentorship:
   - Click "Delete" button - should show confirmation modal
   - Click "Cancel" in modal - should close without deleting
   - Click "Delete" in modal - should remove mentorship from list with success toast
7. Test invalid transitions are prevented (API should return error for cancelled->active)
  </verify>
  <done>
- Active mentorships show "Complete" button that marks them completed
- Completed mentorships show "Revert" button that returns them to active
- All mentorships show "Delete" button that opens confirmation modal
- Delete confirmation requires explicit confirmation before removal
- UI updates immediately after successful operations
- Loading states shown during API calls
- Error messages displayed via toast on failures
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify all Phase 2 functionality works end-to-end</name>
  <what-built>
Complete Discord and status management functionality:
- Inline Discord username editing for mentors and mentees
- Mentorship status transitions (active->completed, completed->active)
- Mentorship deletion with confirmation
- Discord channel URL updates (if implemented)
  </what-built>
  <how-to-verify>
1. Navigate to the admin dashboard at /mentorship/admin
2. Go to "All Mentors" tab

**Test Discord Username Editing:**
3. Find a mentor and click on their Discord username
4. Edit to a new valid username (e.g., "test_user.name") and press Enter
5. Verify success toast appears and username updates
6. Try editing to invalid format (e.g., "UPPERCASE") - should show error toast

**Test Mentorship Status Changes:**
7. Expand a mentor card to see their mentorships
8. Find an active mentorship and click "Complete"
9. Verify the mentorship moves to "Completed Mentorships" section
10. Find the same mentorship and click "Revert"
11. Verify it moves back to "Active Mentorships" section

**Test Mentorship Deletion:**
12. Click "Delete" on any mentorship
13. Verify confirmation modal appears with partner name
14. Click "Cancel" - modal should close, mentorship still there
15. Click "Delete" again, then confirm - mentorship should disappear

**Test Partner Discord Editing:**
16. Within a mentorship row, click on the partner's Discord username
17. Edit and save - should work same as main profile

**Cross-check in All Mentees tab:**
18. Go to "All Mentees" tab
19. Verify same functionality works from mentee perspective
  </how-to-verify>
  <resume-signal>Type "approved" if all functionality works correctly, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. All API endpoints respond correctly (tested in Plan 01)
2. UI updates reflect in both local state and persist to Firestore
3. Error handling shows user-friendly messages via toast
4. Loading states prevent double-submission
5. Delete confirmation prevents accidental data loss
6. Both All Mentors and All Mentees tabs have full functionality
</verification>

<success_criteria>
- Admin can edit Discord usernames inline for any mentor or mentee
- Admin can mark active mentorships as completed with one click
- Admin can revert completed mentorships back to active
- Admin can delete any mentorship with confirmation
- All changes persist to Firestore and update UI immediately
- Invalid operations show clear error messages
- No regressions in existing admin dashboard functionality
</success_criteria>

<output>
After completion, create `.planning/phases/02-discord-status-management/02-02-SUMMARY.md`
</output>
