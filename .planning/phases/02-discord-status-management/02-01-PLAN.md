---
phase: 02-discord-status-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/mentorship/admin/profiles/route.ts
  - src/app/api/mentorship/admin/sessions/route.ts
  - src/app/api/mentorship/admin/sessions/regenerate-channel/route.ts
autonomous: true

must_haves:
  truths:
    - "API accepts Discord username update for any profile and persists to Firestore"
    - "API accepts mentorship status transitions (active->completed, completed->active) with validation"
    - "API accepts mentorship deletion and removes document from Firestore"
    - "Invalid status transitions return 400 error with clear message"
    - "API regenerates Discord channel for a mentorship and returns new channel link"
  artifacts:
    - path: "src/app/api/mentorship/admin/profiles/route.ts"
      provides: "PUT endpoint extended with discordUsername field update"
      contains: "discordUsername"
    - path: "src/app/api/mentorship/admin/sessions/route.ts"
      provides: "PUT for status transitions, DELETE for removal"
      exports: ["PUT", "DELETE"]
    - path: "src/app/api/mentorship/admin/sessions/regenerate-channel/route.ts"
      provides: "POST endpoint to regenerate Discord channel for a mentorship"
      exports: ["POST"]
  key_links:
    - from: "src/app/api/mentorship/admin/profiles/route.ts"
      to: "mentorship_profiles collection"
      via: "Firestore update()"
      pattern: "profileRef\\.update.*discordUsername"
    - from: "src/app/api/mentorship/admin/sessions/route.ts"
      to: "mentorship_sessions collection"
      via: "Firestore update() and delete()"
      pattern: "sessionRef\\.(update|delete)"
    - from: "src/app/api/mentorship/admin/sessions/regenerate-channel/route.ts"
      to: "src/lib/discord.ts"
      via: "createMentorshipChannel()"
      pattern: "createMentorshipChannel"
---

<objective>
Create API endpoints for Discord username updates, mentorship status management, and Discord channel regeneration.

Purpose: Enable admin dashboard to update Discord usernames on profiles, manage mentorship lifecycle (mark complete, revert, delete), and regenerate Discord channels through server-side validated endpoints.

Output: Extended profiles/route.ts with discordUsername update capability, new sessions/route.ts with PUT for status transitions and DELETE for removal, new regenerate-channel/route.ts for creating new Discord channels.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-discord-status-management/02-RESEARCH.md

# Existing patterns to follow
@src/app/api/mentorship/admin/profiles/route.ts
@src/app/api/mentorship/admin/matches/route.ts

# Discord integration (has createMentorshipChannel function)
@src/lib/discord.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend profiles API to support Discord username updates</name>
  <files>src/app/api/mentorship/admin/profiles/route.ts</files>
  <action>
Extend the existing PUT handler in profiles/route.ts to support discordUsername updates:

1. Add discordUsername to the destructured body fields (alongside uid, status, adminNotes, reactivateSessions)

2. Add Discord username validation when discordUsername is provided:
   - Validate format: `/^[a-z0-9_.]{2,32}$/` (Discord's 2023+ format: lowercase, alphanumeric + underscore/period, 2-32 chars)
   - Return 400 with clear error message if invalid: "Invalid Discord username format. Must be 2-32 lowercase characters (letters, numbers, underscore, period)."

3. If discordUsername is provided without status change:
   - Allow update even if status is not provided (make status optional for discord-only updates)
   - Update only discordUsername and updatedAt fields
   - Return success response with uid and updated discordUsername

4. If both discordUsername and status are provided:
   - Process both updates together (existing status logic plus discordUsername)

5. Ensure updatedAt is always set to new Date() on any update

Do NOT:
- Break existing status update functionality
- Use set() instead of update() (would overwrite document)
- Allow discordUsername with discriminator format (Username#1234 is invalid)
  </action>
  <verify>
Test with curl:
```bash
# Valid Discord username update
curl -X PUT http://localhost:3000/api/mentorship/admin/profiles \
  -H "Content-Type: application/json" \
  -d '{"uid": "test-uid", "discordUsername": "valid_user.name"}'
# Should return 200 with success: true

# Invalid format (uppercase)
curl -X PUT http://localhost:3000/api/mentorship/admin/profiles \
  -H "Content-Type: application/json" \
  -d '{"uid": "test-uid", "discordUsername": "InvalidUser"}'
# Should return 400 with error about invalid format

# Invalid format (too short)
curl -X PUT http://localhost:3000/api/mentorship/admin/profiles \
  -H "Content-Type: application/json" \
  -d '{"uid": "test-uid", "discordUsername": "a"}'
# Should return 400

# Existing status update still works
curl -X PUT http://localhost:3000/api/mentorship/admin/profiles \
  -H "Content-Type: application/json" \
  -d '{"uid": "test-uid", "status": "accepted"}'
# Should return 200
```
  </verify>
  <done>
- Discord username updates work via PUT /api/mentorship/admin/profiles with {uid, discordUsername}
- Invalid Discord formats return 400 with helpful error message
- Existing status update functionality unchanged
- updatedAt timestamp set on all updates
  </done>
</task>

<task type="auto">
  <name>Task 2: Create sessions API for status transitions and deletion</name>
  <files>src/app/api/mentorship/admin/sessions/route.ts</files>
  <action>
Create new file src/app/api/mentorship/admin/sessions/route.ts with PUT and DELETE handlers:

**PUT handler for status transitions:**

1. Parse body: { sessionId, status }
2. Validate sessionId is provided
3. Validate status is one of: 'active', 'completed' (only allowed transition targets)
4. Fetch current session from mentorship_sessions collection
5. Return 404 if session doesn't exist
6. Implement state machine validation:
   ```
   ALLOWED_TRANSITIONS = {
     pending: ['active', 'cancelled'],
     active: ['completed', 'cancelled'],
     completed: ['active'],  // Allows revert
     cancelled: []  // Terminal state
   }
   ```
7. If transition not allowed, return 400 with message: "Cannot transition from {current} to {new}"
8. Update session with:
   - status: new status
   - updatedAt: server timestamp
   - completedAt: server timestamp (only if status === 'completed')
   - revertedAt: server timestamp (only if current === 'completed' and new === 'active')
9. Return success response with sessionId and new status

**DELETE handler for mentorship removal:**

1. Get sessionId from URL search params: request.url searchParams.get('id')
2. Validate sessionId is provided, return 400 if missing
3. Fetch session to verify it exists
4. Return 404 if session doesn't exist
5. Delete the document using db.collection('mentorship_sessions').doc(sessionId).delete()
6. Return success response with deleted sessionId

Use patterns from existing profiles/route.ts:
- import { NextRequest, NextResponse } from 'next/server'
- import { db } from '@/lib/firebaseAdmin'
- import * as admin from 'firebase-admin' (for FieldValue.serverTimestamp if needed)
- try/catch with console.error and 500 response on failures
  </action>
  <verify>
Test with curl:
```bash
# Status transition: active -> completed
curl -X PUT http://localhost:3000/api/mentorship/admin/sessions \
  -H "Content-Type: application/json" \
  -d '{"sessionId": "test-session-id", "status": "completed"}'
# Should return 200 if session exists and transition valid

# Invalid transition: cancelled -> active
curl -X PUT http://localhost:3000/api/mentorship/admin/sessions \
  -H "Content-Type: application/json" \
  -d '{"sessionId": "test-session-id", "status": "active"}'
# Should return 400 with transition error message

# Delete mentorship
curl -X DELETE "http://localhost:3000/api/mentorship/admin/sessions?id=test-session-id"
# Should return 200 with success: true

# Delete without id
curl -X DELETE "http://localhost:3000/api/mentorship/admin/sessions"
# Should return 400 with missing id error
```
  </verify>
  <done>
- PUT /api/mentorship/admin/sessions accepts {sessionId, status} for status transitions
- State machine validates transitions (active->completed, completed->active allowed)
- Invalid transitions return 400 with clear error message
- DELETE /api/mentorship/admin/sessions?id={sessionId} removes mentorship document
- completedAt timestamp added when marking complete
- revertedAt timestamp added when reverting to active
  </done>
</task>

<task type="auto">
  <name>Task 3: Create regenerate-channel API endpoint</name>
  <files>src/app/api/mentorship/admin/sessions/regenerate-channel/route.ts</files>
  <action>
Create new file src/app/api/mentorship/admin/sessions/regenerate-channel/route.ts with POST handler:

**POST handler for Discord channel regeneration:**

1. Parse body: { sessionId }
2. Validate sessionId is provided, return 400 if missing
3. Fetch session from mentorship_sessions collection by sessionId
4. Return 404 if session doesn't exist
5. Validate session status is 'active' or 'completed' (only allow regeneration for established mentorships)
   - Return 400 with message: "Can only regenerate channel for active or completed mentorships"
6. Get mentor and mentee profile data:
   - Fetch mentor profile from mentorship_profiles using session.mentorId
   - Fetch mentee profile from mentorship_profiles using session.menteeId
   - Extract displayName and discordUsername from each profile
7. Call existing createMentorshipChannel() from src/lib/discord.ts:
   ```typescript
   import { createMentorshipChannel } from '@/lib/discord'

   const channelResult = await createMentorshipChannel(
     mentorProfile.displayName,
     menteeProfile.displayName,
     sessionId,
     mentorProfile.discordUsername,
     menteeProfile.discordUsername
   )
   ```
8. If channel creation fails (null result), return 500 with message: "Failed to create Discord channel"
9. Update session document with new channel info:
   ```typescript
   await db.collection('mentorship_sessions').doc(sessionId).update({
     discordChannelId: channelResult.channelId,
     discordChannelUrl: channelResult.channelUrl,
     updatedAt: new Date()
   })
   ```
10. Return success response with new channel URL:
    ```json
    { "success": true, "channelUrl": "https://discord.com/channels/..." }
    ```

Use patterns from existing admin routes:
- import { NextRequest, NextResponse } from 'next/server'
- import { db } from '@/lib/firebaseAdmin'
- try/catch with console.error and 500 response on failures
  </action>
  <verify>
Test with curl:
```bash
# Regenerate channel for active mentorship
curl -X POST http://localhost:3000/api/mentorship/admin/sessions/regenerate-channel \
  -H "Content-Type: application/json" \
  -d '{"sessionId": "existing-session-id"}'
# Should return 200 with { success: true, channelUrl: "https://discord.com/channels/..." }

# Missing sessionId
curl -X POST http://localhost:3000/api/mentorship/admin/sessions/regenerate-channel \
  -H "Content-Type: application/json" \
  -d '{}'
# Should return 400 with error about missing sessionId

# Non-existent session
curl -X POST http://localhost:3000/api/mentorship/admin/sessions/regenerate-channel \
  -H "Content-Type: application/json" \
  -d '{"sessionId": "fake-id"}'
# Should return 404
```

Verify in Discord that a new channel is created with correct permissions for mentor and mentee.
  </verify>
  <done>
- POST /api/mentorship/admin/sessions/regenerate-channel accepts {sessionId}
- Creates new Discord channel using existing createMentorshipChannel() function
- Updates session with new discordChannelId and discordChannelUrl
- Returns new channel URL in response
- Only works for active or completed mentorships
  </done>
</task>

</tasks>

<verification>
1. Run `npm run build` to verify no TypeScript errors
2. Test all API endpoints with curl commands from task verify sections
3. Check Firestore (via Firebase console) that documents update correctly:
   - Profile discordUsername field updates
   - Session status field transitions
   - Session documents delete on DELETE request
   - Session discordChannelId and discordChannelUrl update on regeneration
   - Timestamps (updatedAt, completedAt, revertedAt) set appropriately
4. Check Discord server that regenerated channel appears with correct permissions
</verification>

<success_criteria>
- Profiles API: PUT with discordUsername validates format and updates Firestore
- Sessions API: PUT validates state machine, transitions status, adds timestamps
- Sessions API: DELETE removes document from mentorship_sessions
- Regenerate API: POST creates new Discord channel and updates session
- All existing profile status functionality unchanged
- No TypeScript errors, build passes
</success_criteria>

<output>
After completion, create `.planning/phases/02-discord-status-management/02-01-SUMMARY.md`
</output>
