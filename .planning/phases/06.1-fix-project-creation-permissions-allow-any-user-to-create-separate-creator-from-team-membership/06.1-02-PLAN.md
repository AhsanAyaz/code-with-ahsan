---
phase: 06.1-fix-project-creation-permissions-allow-any-user-to-create-separate-creator-from-team-membership
plan: 02
type: execute
wave: 2
depends_on: ["06.1-01"]
files_modified:
  - src/app/api/projects/[id]/join/route.ts
  - src/app/api/projects/[id]/leave/route.ts
  - src/components/projects/TeamRoster.tsx
  - src/app/projects/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Creator can join their own project as a team member via Join Project button"
    - "Creator who is a member can leave the project (retains owner permissions)"
    - "Creator who is not a member cannot leave (no member document to delete)"
    - "Creator is always shown separately in team roster regardless of membership"
    - "Creator who is also a member shows 'Creator - Member' dual-role badge"
    - "Creator who is not a member shows 'Creator' badge only"
    - "Non-creator members can still leave as before"
    - "Discord operations fire correctly when creator joins/leaves"
  artifacts:
    - path: "src/app/api/projects/[id]/join/route.ts"
      provides: "POST endpoint for creator to join their own project as member"
      exports: ["POST"]
    - path: "src/app/api/projects/[id]/leave/route.ts"
      provides: "Updated leave endpoint allowing creator-members to leave"
      exports: ["POST"]
    - path: "src/components/projects/TeamRoster.tsx"
      provides: "Updated team roster with dual-role badge and creator deduplication"
      contains: "Creator"
    - path: "src/app/projects/[id]/page.tsx"
      provides: "Join Project button for creator, updated Leave button visibility"
      contains: "handleJoinProject"
  key_links:
    - from: "src/app/projects/[id]/page.tsx"
      to: "/api/projects/[id]/join"
      via: "authFetch POST call"
      pattern: "authFetch.*join"
    - from: "src/app/projects/[id]/page.tsx"
      to: "/api/projects/[id]/leave"
      via: "authFetch POST call"
      pattern: "authFetch.*leave"
    - from: "src/components/projects/TeamRoster.tsx"
      to: "members array"
      via: "filter to exclude creator from member list to prevent duplication"
      pattern: "filter.*creatorId"
---

<objective>
Create the "Join Project" endpoint for creators, fix the leave endpoint to allow creator-members to leave, and update the UI to show proper dual-role badges and a Join Project button.

Purpose: Separates creator role from team membership. Creator can optionally join as a member (gets Discord access, appears in member roster) and can leave later (retains owner permissions). This enables "hands-off creator" and "active creator" patterns.

Output: New join endpoint, updated leave endpoint, updated TeamRoster component, updated project detail page.
</objective>

<execution_context>
@/Users/amu1o5/.claude/get-shit-done/workflows/execute-plan.md
@/Users/amu1o5/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06.1-fix-project-creation-permissions-allow-any-user-to-create-separate-creator-from-team-membership/06.1-RESEARCH.md
@.planning/phases/06.1-fix-project-creation-permissions-allow-any-user-to-create-separate-creator-from-team-membership/06.1-01-SUMMARY.md
@src/app/api/projects/[id]/leave/route.ts
@src/app/api/projects/[id]/applications/[userId]/route.ts
@src/components/projects/TeamRoster.tsx
@src/app/projects/[id]/page.tsx
@src/lib/discord.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create join endpoint and fix leave endpoint</name>
  <files>
    src/app/api/projects/[id]/join/route.ts
    src/app/api/projects/[id]/leave/route.ts
  </files>
  <action>
**Create NEW file `src/app/api/projects/[id]/join/route.ts`:**

Follow the exact patterns from the application approval endpoint (`src/app/api/projects/[id]/applications/[userId]/route.ts`) for batch writes and Discord operations.

```typescript
import { NextRequest, NextResponse } from "next/server";
import { db } from "@/lib/firebaseAdmin";
import { FieldValue } from "firebase-admin/firestore";
import { addMemberToChannel, sendChannelMessage, lookupMemberByUsername } from "@/lib/discord";
import { verifyAuth } from "@/lib/auth";

export async function POST(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    const authResult = await verifyAuth(request);
    if (!authResult) {
      return NextResponse.json(
        { error: "Authentication required" },
        { status: 401 }
      );
    }

    const { id: projectId } = await params;
    const userId = authResult.uid;

    // Fetch project
    const projectDoc = await db.collection("projects").doc(projectId).get();
    if (!projectDoc.exists) {
      return NextResponse.json(
        { error: "Project not found" },
        { status: 404 }
      );
    }

    const projectData = projectDoc.data();

    // Only creator can use this endpoint
    if (projectData?.creatorId !== userId) {
      return NextResponse.json(
        { error: "Only the project creator can join via this endpoint" },
        { status: 403 }
      );
    }

    // Check project is active
    if (projectData?.status !== "active") {
      return NextResponse.json(
        { error: "Can only join active projects" },
        { status: 400 }
      );
    }

    // Check not already a member (composite key lookup)
    const memberDocId = `${projectId}_${userId}`;
    const memberRef = db.collection("project_members").doc(memberDocId);
    const existingMember = await memberRef.get();

    if (existingMember.exists) {
      return NextResponse.json(
        { error: "You are already a team member" },
        { status: 409 }
      );
    }

    // Check team capacity using memberCount from project document
    if (projectData?.maxTeamSize && projectData.memberCount >= projectData.maxTeamSize) {
      return NextResponse.json(
        { error: "Team is full" },
        { status: 409 }
      );
    }

    // Fetch creator's profile for member document
    const creatorProfileDoc = await db
      .collection("mentorship_profiles")
      .doc(userId)
      .get();
    const creatorProfileData = creatorProfileDoc.data();

    // Batch write: create member doc + update project
    const batch = db.batch();

    // 1. Create ProjectMember document with composite key
    batch.set(memberRef, {
      projectId,
      userId,
      userProfile: {
        displayName: creatorProfileData?.displayName || projectData?.creatorProfile?.displayName || "",
        photoURL: creatorProfileData?.photoURL || projectData?.creatorProfile?.photoURL || "",
        username: creatorProfileData?.username || projectData?.creatorProfile?.username || "",
        discordUsername: creatorProfileData?.discordUsername || projectData?.creatorProfile?.discordUsername || "",
      },
      role: "member",
      joinedAt: FieldValue.serverTimestamp(),
    });

    // 2. Increment memberCount and update lastActivityAt
    const projectRef = db.collection("projects").doc(projectId);
    batch.update(projectRef, {
      memberCount: FieldValue.increment(1),
      lastActivityAt: FieldValue.serverTimestamp(),
    });

    await batch.commit();

    // Non-blocking Discord operations
    // Creator already has Discord channel access from project approval (createProjectChannel adds creator).
    // Just send a notification message to the channel.
    if (projectData?.discordChannelId) {
      const discordUsername = creatorProfileData?.discordUsername || projectData?.creatorProfile?.discordUsername;
      let tag: string;

      if (discordUsername) {
        try {
          const discordMember = await lookupMemberByUsername(discordUsername);
          tag = discordMember ? `<@${discordMember.id}>` : `**${creatorProfileData?.displayName || "The creator"}**`;
        } catch {
          tag = `**${creatorProfileData?.displayName || "The creator"}**`;
        }
      } else {
        tag = `**${creatorProfileData?.displayName || "The creator"}**`;
      }

      try {
        await sendChannelMessage(
          projectData.discordChannelId,
          `ðŸŽ‰ ${tag} (project creator) has joined the team as a member!`
        );
      } catch (error) {
        console.error("Discord join message failed:", error);
      }

      // If creator somehow doesn't have channel access, add them
      if (discordUsername) {
        try {
          await addMemberToChannel(projectData.discordChannelId, discordUsername);
        } catch (error) {
          console.error("Discord member add failed:", error);
        }
      }
    }

    return NextResponse.json(
      { success: true, message: "Successfully joined the project" },
      { status: 200 }
    );
  } catch (error) {
    console.error("Error joining project:", error);
    return NextResponse.json(
      { error: "Failed to join project" },
      { status: 500 }
    );
  }
}
```

**Update `src/app/api/projects/[id]/leave/route.ts`:**

Replace the creator-blocking logic (lines 35-43) with a membership check. The creator should be allowed to leave if they have a ProjectMember document.

Change the current block:
```typescript
// Prevent creator from leaving
if (projectData?.creatorId === userId) {
  return NextResponse.json(
    {
      error: "Project creator cannot leave. Transfer ownership first.",
    },
    { status: 403 }
  );
}
```

To simply remove that block entirely. The existing membership check on lines 46-55 already handles the case where a user isn't a member:
```typescript
const memberDocId = `${projectId}_${userId}`;
const memberRef = db.collection("project_members").doc(memberDocId);
const memberDoc = await memberRef.get();

if (!memberDoc.exists) {
  return NextResponse.json(
    { error: "Member not found" },
    { status: 404 }
  );
}
```

This means:
- Creator who is NOT a member â†’ hits "Member not found" (404) â€” correct
- Creator who IS a member â†’ proceeds to leave flow â€” correct
- Regular member â†’ proceeds to leave flow â€” correct (unchanged behavior)

No other changes needed to the leave endpoint. The existing batch delete (member doc + application doc + decrement memberCount) and Discord operations work correctly for creator-members too.
  </action>
  <verify>
1. Verify `src/app/api/projects/[id]/join/route.ts` exists and exports POST function.
2. Verify `src/app/api/projects/[id]/leave/route.ts` no longer contains "Project creator cannot leave" string.
3. Grep for "Transfer ownership" in leave/route.ts â€” should not be found.
4. `npx tsc --noEmit` â€” no TypeScript compilation errors.
  </verify>
  <done>
- New POST /api/projects/[id]/join endpoint exists for creator self-join
- Join endpoint validates: auth, creator-only, active project, not already member, team capacity
- Join uses batch write pattern: create ProjectMember + increment memberCount + update lastActivityAt
- Join sends non-blocking Discord notification message
- Leave endpoint no longer blocks creator from leaving
- Leave endpoint relies on membership check (404 if not a member) instead of creator check
  </done>
</task>

<task type="auto">
  <name>Task 2: Update TeamRoster and project detail page UI</name>
  <files>
    src/components/projects/TeamRoster.tsx
    src/app/projects/[id]/page.tsx
  </files>
  <action>
**Update `src/components/projects/TeamRoster.tsx`:**

1. Add a check to detect if creator is also in the members array:
```typescript
const isCreatorAlsoMember = members.some(m => m.userId === project.creatorId);
```

2. Filter creator out of members array to prevent duplicate rendering (creator already has their own card):
```typescript
const nonCreatorMembers = members.filter(m => m.userId !== project.creatorId);
```

3. Update the total member count to use the non-creator filtered list:
```typescript
const totalMembers = nonCreatorMembers.length + 1; // +1 for creator (always shown)
```

4. Update the creator badge to show dual-role when creator is also a member:
Replace:
```jsx
<span className="badge badge-primary">Creator</span>
```
With:
```jsx
{isCreatorAlsoMember ? (
  <span className="badge badge-primary">Creator &middot; Member</span>
) : (
  <span className="badge badge-primary badge-outline">Creator</span>
)}
```
When creator is also a member, show solid "Creator Â· Member" badge. When creator is NOT a member, show outline "Creator" badge to visually distinguish.

5. Update the members map to use `nonCreatorMembers` instead of `members`:
```jsx
{nonCreatorMembers.map((member) => (
```

6. Update the empty state to also use `nonCreatorMembers`:
```jsx
{nonCreatorMembers.length === 0 && (
```

**Update `src/app/projects/[id]/page.tsx`:**

1. Add `isCreatorMember` derived state alongside existing `isCreator` and `isMember`:
```typescript
const isCreatorMember = isCreator && isMember;
```

2. Add `joinLoading` state:
```typescript
const [joinLoading, setJoinLoading] = useState(false);
```

3. Add `handleJoinProject` handler (place it near `handleLeaveProject`):
```typescript
const handleJoinProject = async () => {
  setJoinLoading(true);
  try {
    const response = await authFetch(`/api/projects/${projectId}/join`, {
      method: "POST",
    });

    if (response.ok) {
      fetchProjectData();
      showToast("You've joined the project as a team member!", "success");
    } else {
      const data = await response.json();
      showToast(data.error || "Failed to join project", "error");
    }
  } catch (error) {
    console.error("Error joining project:", error);
    showToast("An error occurred", "error");
  } finally {
    setJoinLoading(false);
  }
};
```

4. Add "Join Project" button for creator who is NOT a member. Place it right after the TeamRoster component and before the Leave Project button section:
```jsx
{/* Join Project Button â€” for creator who hasn't joined */}
{isCreator && !isMember && project.status === "active" && (
  <div className="flex justify-end">
    <button
      onClick={handleJoinProject}
      className="btn btn-primary btn-sm"
      disabled={joinLoading}
    >
      {joinLoading ? (
        <>
          <span className="loading loading-spinner loading-sm"></span>
          Joining...
        </>
      ) : (
        "Join Project"
      )}
    </button>
  </div>
)}
```

5. Update the "Leave Project" button visibility. Currently:
```jsx
{isMember && !isCreator && (
```
Change to allow creator-members to see it too:
```jsx
{isMember && (
```
This means any member (including creator-members) can see the Leave button. The leave endpoint handles the logic correctly â€” creator-members leave as members but retain owner permissions.

6. Update the handleLeaveProject confirm message for creator-members to be more specific. Add a conditional message:
```typescript
const handleLeaveProject = () => {
  showConfirm({
    title: "Leave Project",
    message: isCreator
      ? "Are you sure you want to leave as a team member? You'll retain creator permissions but lose Discord channel access."
      : "Are you sure you want to leave this project?",
    confirmLabel: "Leave",
    confirmClass: "btn-error",
    onConfirm: async () => {
      // ... existing logic unchanged
    },
  });
};
```
  </action>
  <verify>
1. `npx tsc --noEmit` â€” no TypeScript compilation errors.
2. Grep TeamRoster.tsx for "nonCreatorMembers" â€” should appear (deduplication filter).
3. Grep page.tsx for "handleJoinProject" â€” should appear (join button handler).
4. Grep page.tsx for "Join Project" â€” should appear (button text).
5. Verify page.tsx leave button condition is `{isMember && (` not `{isMember && !isCreator && (`.
  </verify>
  <done>
- TeamRoster filters creator from members array to prevent duplication
- TeamRoster shows "Creator Â· Member" dual-role badge when creator is also a member
- TeamRoster shows outline "Creator" badge when creator is not a member (visual distinction)
- Project detail page has "Join Project" button for creator who hasn't joined (only on active projects)
- Project detail page allows creator-members to see and use Leave button
- Leave confirmation message differs for creator vs regular member
- All TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` â€” no compilation errors across entire project
2. Verify new join endpoint: `src/app/api/projects/[id]/join/route.ts` exists
3. Verify leave endpoint: no "creator cannot leave" block
4. Verify TeamRoster: creator deduplication, dual-role badge
5. Verify page: Join button, updated leave visibility
</verification>

<success_criteria>
- Creator can join their own project via POST /api/projects/[id]/join (creates ProjectMember, increments count, Discord notification)
- Creator who is a member can leave (deletes ProjectMember, decrements count, removes Discord access)
- Creator who is not a member sees "Join Project" button on active projects
- Creator who is a member sees "Leave Project" button with appropriate warning
- TeamRoster shows creator with correct badge ("Creator" or "Creator Â· Member") and never duplicates creator in member list
- All TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/06.1-fix-project-creation-permissions-allow-any-user-to-create-separate-creator-from-team-membership/06.1-02-SUMMARY.md`
</output>
