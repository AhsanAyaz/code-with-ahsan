# Phase 6.1: Fix Project Creation Permissions - Research

**Researched:** 2026-02-11
**Domain:** Authorization, Permission System, Discord Integration, UI/UX Separation
**Confidence:** HIGH

## Summary

This phase fixes a critical architectural flaw where project creation is incorrectly restricted to mentors only, and creators are automatically added as team members. The current implementation violates the product requirement that any authenticated user should be able to create projects.

The core issues identified:

1. **Permission Logic Error (permissions.ts)**: `canCreateProject()` returns `isAcceptedMentor(user)` - should return `isAuthenticated(user)`
2. **Automatic Member Creation**: POST /api/projects/[id]/applications/[userId] approval flow creates ProjectMember, effectively making creator a member when they approve
3. **Leave Prevention**: POST /api/projects/[id]/leave blocks creator from leaving, but there's no mechanism for creator to explicitly join
4. **UI Confusion**: TeamRoster.tsx shows creator in team count (`totalMembers = members.length + 1`) but creator is never in `members` array
5. **Discord Coupling**: createProjectChannel adds creator to Discord channel during approval, assuming creator is always a member

**Primary recommendation:** Treat creator as owner-but-not-member by default. Add explicit "Join Project" action for creator. Separate Discord operations for owners vs members.

## Current State Analysis

### Permission System (src/lib/permissions.ts)

**Line 102-104:**
```typescript
export function canCreateProject(user: PermissionUser | null): boolean {
  return isAcceptedMentor(user);
}
```

**Issue:** Hardcoded to check mentor role + accepted status. This is the primary blocker.

**Correct behavior:** Should check `isAuthenticated(user)` only.

### Project Creation Flow (src/app/api/projects/route.ts)

**Current flow:**
1. User submits project ‚Üí POST /api/projects
2. Permission check: `if (!canCreateProject(permissionUser))` fails for non-mentors (line 95)
3. Project created with status "pending", memberCount: 0 (line 121)
4. Creator info stored in `creatorProfile` denormalized field (line 110-115)
5. No ProjectMember document created for creator

**Key observation:** Project creation does NOT create a ProjectMember for creator. This is correct behavior that we need to preserve.

### Discord Integration (src/lib/discord.ts)

**createProjectChannel (lines 961-1078):**
```typescript
export async function createProjectChannel(
  projectTitle: string,
  creatorName: string,
  projectId: string,
  creatorDiscordUsername?: string
): Promise<ChannelResult | null>
```

**Current behavior:**
- If `creatorDiscordUsername` provided, looks up Discord member and adds VIEW_CHANNEL + SEND_MESSAGES permissions (lines 1005-1014)
- Sends welcome message tagging creator
- Creator gets Discord access immediately on project approval

**Issue:** This assumes creator is a team member. If creator hasn't joined, they shouldn't automatically get Discord channel access.

**Discord member operations (lines 1182-1269):**
- `addMemberToChannel()`: Grants VIEW_CHANNEL + SEND_MESSAGES to a Discord username
- `removeMemberFromChannel()`: Deletes permission overwrite for a Discord username

These are used in:
- Application approval (src/app/api/projects/[id]/applications/[userId]/route.ts line 127)
- Leave project (src/app/api/projects/[id]/leave/route.ts line 92)

**Critical insight:** Discord operations only fire when ProjectMember exists AND user has discordUsername. We need to use this pattern for creator joining/leaving.

### Application Approval Flow

**PUT /api/projects/[id]/applications/[userId] (approve action):**

Lines 76-108:
```typescript
const batch = db.batch();

// 1. Update application status to approved
batch.update(applicationRef, {
  status: "approved",
  approvedAt: FieldValue.serverTimestamp(),
});

// 2. Create project_members document
const memberId = `${projectId}_${userId}`;
const memberRef = db.collection("project_members").doc(memberId);
batch.set(memberRef, {
  projectId,
  userId,
  userProfile: applicationData?.userProfile || {...},
  role: "member",
  joinedAt: FieldValue.serverTimestamp(),
});

// 3. Update project lastActivityAt and increment memberCount
const projectRef = db.collection("projects").doc(projectId);
batch.update(projectRef, {
  lastActivityAt: FieldValue.serverTimestamp(),
  memberCount: FieldValue.increment(1),
});

await batch.commit();
```

**Key observation:** This is the atomic pattern we need for creator joining. Three operations: create member doc, update project, Discord operations.

### Leave Project Flow

**POST /api/projects/[id]/leave:**

Lines 35-42:
```typescript
// Prevent creator from leaving
if (projectData?.creatorId === userId) {
  return NextResponse.json(
    {
      error: "Project creator cannot leave. Transfer ownership first.",
    },
    { status: 403 }
  );
}
```

**Issue:** Hardcoded prevention. No concept of "creator who hasn't joined" vs "creator who is also a member."

**Correct behavior:** Check if user is creator AND a member. If creator but not member, already not in project. If creator AND member, allow leaving (they remain owner, just not member).

### UI Representation (src/components/projects/TeamRoster.tsx)

**Lines 21, 30-52:**
```typescript
const totalMembers = members.length + 1; // +1 for creator

// Creator card rendered separately
<div className="flex items-center gap-3 p-3 bg-base-200 rounded-lg">
  {/* Creator profile display */}
  <span className="badge badge-primary">Creator</span>
</div>
```

**Issue:** Creator shown in team roster with "Creator" badge, counted in total members, but not in actual `members` array.

**Current behavior matches desired behavior:** Creator IS shown separately from members. We just need to clarify when creator is ALSO a member.

**Proposed UI fix:**
- Show creator separately with "Creator" badge always
- If creator is also in `members` array, show badge as "Creator ‚Ä¢ Member"
- Add "Join Project" button for creator if they haven't joined
- Creator can leave (removes from members but stays as creator)

## Data Model Analysis

### Project Document (Firestore: projects collection)

```typescript
{
  id: string;
  creatorId: string;           // Creator's UID - never changes
  creatorProfile: {            // Denormalized creator info
    displayName: string;
    photoURL: string;
    username?: string;
    discordUsername?: string;
  };
  memberCount: number;         // Count of ProjectMember documents
  // ... other fields
}
```

**Key insight:** `creatorId` is permanent. `memberCount` only counts ProjectMember documents, not the creator.

### ProjectMember Document (Firestore: project_members collection)

```typescript
{
  id: string;                  // Composite: {projectId}_{userId}
  projectId: string;
  userId: string;
  role: "owner" | "member";    // Currently only "member" used
  joinedAt: Date;
}
```

**Observation:** `role` field exists but is always "member" in current implementation. We COULD use "owner" for creator-members, but it's safer to check `userId === project.creatorId` for owner permissions.

**Decision point:** Should we create a ProjectMember with role="owner" when creator joins? Or keep role="member" and check creatorId separately?

**Recommendation:** Keep role="member" even for creator. Owner status is derived from `project.creatorId`, not from ProjectMember.role. This keeps the data model simple.

## Permission Matrix

| User Type | Can Create | Can Apply | Can Join (via invite) | Can Manage Team | Can Leave | Has Discord Access |
|-----------|------------|-----------|----------------------|-----------------|-----------|-------------------|
| **Creator (not member)** | ‚úÖ | ‚ùå (own project) | ‚úÖ (via Join button) | ‚úÖ (always) | N/A (not member) | ‚ùå |
| **Creator (is member)** | ‚úÖ | ‚ùå (own project) | N/A (already member) | ‚úÖ (always) | ‚úÖ (becomes not-member) | ‚úÖ |
| **Authenticated user** | ‚úÖ | ‚úÖ | ‚úÖ (via invitation) | ‚ùå | N/A (not member) | ‚ùå |
| **Team member** | ‚úÖ | N/A (already member) | N/A (already member) | ‚ùå | ‚úÖ | ‚úÖ |

## Required Changes

### 1. Fix canCreateProject Permission

**File:** `src/lib/permissions.ts`
**Current (line 102-104):**
```typescript
export function canCreateProject(user: PermissionUser | null): boolean {
  return isAcceptedMentor(user);
}
```

**Change to:**
```typescript
export function canCreateProject(user: PermissionUser | null): boolean {
  return isAuthenticated(user);
}
```

**Impact:** Any authenticated user can now create projects.

**Test cases needed:**
- ‚úÖ Authenticated user with no role ‚Üí can create
- ‚úÖ Authenticated mentee ‚Üí can create
- ‚úÖ Authenticated mentor ‚Üí can create
- ‚ùå Unauthenticated user ‚Üí cannot create

### 2. Update Firestore Security Rules

**File:** `firestore.rules` (assumed location)
**Current rule likely:**
```javascript
allow create: if isSignedIn() && isAcceptedMentor();
```

**Change to:**
```javascript
allow create: if isSignedIn();
```

**Note:** Need to verify current rules location and format.

### 3. Add "Join Project" Endpoint for Creator

**New endpoint:** `POST /api/projects/[id]/join`

**Purpose:** Allow creator to explicitly join their own project as a member.

**Logic:**
```typescript
// 1. Verify auth
// 2. Check user is creator: project.creatorId === userId
// 3. Check not already a member: ProjectMember {projectId}_{userId} doesn't exist
// 4. Check team not full: memberCount < maxTeamSize
// 5. Batch write:
//    - Create ProjectMember doc with role="member"
//    - Increment project.memberCount
//    - Update project.lastActivityAt
// 6. Non-blocking Discord: addMemberToChannel if discordUsername exists
```

**Key difference from application approval:** No application document involved. Creator joins directly.

### 4. Update Leave Endpoint Logic

**File:** `src/app/api/projects/[id]/leave/route.ts`
**Current (lines 35-42):** Blocks creator from leaving unconditionally

**Change to:**
```typescript
// Check if user is a member
const memberDocId = `${projectId}_${userId}`;
const memberRef = db.collection("project_members").doc(memberDocId);
const memberDoc = await memberRef.get();

if (!memberDoc.exists) {
  return NextResponse.json(
    { error: "You are not a member of this project" },
    { status: 404 }
  );
}

// Allow creator to leave if they are a member
// They retain owner permissions even after leaving
```

**Remove:** Creator-specific blocking code.

**Discord behavior:** Send departure message and remove from channel (existing behavior is correct).

### 5. Update Discord Channel Creation

**File:** `src/lib/discord.ts`
**Function:** `createProjectChannel` (lines 961-1078)

**Current:** Adds creator to channel permissions immediately.

**Change:** Do NOT add creator to channel permissions during channel creation. Only add them if they're in the ProjectMember collection.

**Alternative approach:** Keep current behavior but add comment explaining creator gets access during approval. Then remove creator from channel later if they leave. This is simpler.

**Recommendation:** Keep current behavior for MVP. Creator gets Discord access on approval (as they likely want to set up the channel). If they leave, Discord permissions are removed. This aligns with existing patterns.

### 6. Update UI Components

#### TeamRoster.tsx

**File:** `src/components/projects/TeamRoster.tsx`

**Current behavior:** Creator always shown separately with "Creator" badge.

**Change:** Check if creator is also in members array. If yes, show "Creator ‚Ä¢ Member" badge instead of just "Creator".

```typescript
const isCreatorAlsoMember = members.some(m => m.userId === project.creatorId);

// In creator card JSX:
{isCreatorAlsoMember ? (
  <span className="badge badge-primary">Creator ‚Ä¢ Member</span>
) : (
  <span className="badge badge-primary">Creator</span>
)}
```

**Total count:** Keep current logic (`members.length + 1`) - this counts creator separately, which is correct for UI purposes.

#### Project Detail Page

**File:** `src/app/projects/[id]/page.tsx`

**Add:** "Join Project" button for creator if they haven't joined.

**Logic:**
```typescript
const isCreator = user && project?.creatorId === user.uid;
const isCreatorMember = isCreator && members.some(m => m.userId === user?.uid);

// Show join button if:
// - User is creator
// - Creator is not in members array
// - Team is not full
{isCreator && !isCreatorMember && memberCount < maxTeamSize && (
  <button onClick={handleJoinProject}>Join Project</button>
)}
```

**Handle function:**
```typescript
const handleJoinProject = async () => {
  const response = await authFetch(`/api/projects/${projectId}/join`, {
    method: "POST",
  });

  if (response.ok) {
    fetchProjectData(); // Refresh
    showToast("You've joined the project!", "success");
  } else {
    const data = await response.json();
    showToast(data.error || "Failed to join project", "error");
  }
};
```

### 7. Update Permission Tests

**File:** `src/lib/__tests__/permissions.test.ts` (assumed location)

**Update test cases for canCreateProject:**
- Remove tests expecting mentor-only behavior
- Add tests for any authenticated user
- Verify unauthenticated users still blocked

## Architecture Patterns

### Owner vs Member Separation Pattern

**Principle:** Ownership is a permanent role derived from `project.creatorId`. Membership is a temporary role tracked in `project_members` collection.

**Benefits:**
- Creator retains management permissions even after leaving team
- Creator can observe project progress without being in Discord channel
- Allows for "hands-off creator" use case (create project, recruit team, step back)
- Simplifies permission checks: `isOwner = userId === project.creatorId`

**Implementation:**
```typescript
// Permission checks
const isOwner = user?.uid === project.creatorId;
const isMember = members.some(m => m.userId === user?.uid);

// Management permissions
const canManage = isOwner || user?.isAdmin;

// Discord access
const hasDiscordAccess = isMember && project.discordChannelId;

// Leave action
const canLeave = isMember && !isOwner; // Wrong - creator CAN leave as member
const canLeave = isMember; // Correct - anyone who is a member can leave
```

### Batch Write Pattern (existing, reuse)

From application approval (route.ts lines 76-108):
```typescript
const batch = db.batch();

// 1. Create/update primary document
batch.set(memberRef, {...});

// 2. Update related counters
batch.update(projectRef, {
  memberCount: FieldValue.increment(1),
  lastActivityAt: FieldValue.serverTimestamp(),
});

// 3. Update/delete related documents
batch.update(applicationRef, {...});

await batch.commit();

// 4. Non-blocking Discord operations after commit
try {
  await addMemberToChannel(...);
} catch (error) {
  console.error("Discord operation failed:", error);
}
```

**Pattern:** Firestore operations in batch for atomicity. Discord operations after commit, non-blocking.

**Reuse for creator join:** Same pattern, minus application update.

## Common Pitfalls

### Pitfall 1: Forgetting Creator in Discord Operations

**What goes wrong:** Creator joins project as member, but existing Discord addMemberToChannel calls don't account for "creator who just became member."

**Why it happens:** createProjectChannel already added creator to Discord on approval. When creator joins, duplicate permission overwrites don't cause errors, but logic gets confusing.

**How to avoid:** Document that creator gets Discord access on approval. When creator joins via /join endpoint, check if they already have Discord permissions before calling addMemberToChannel.

**Warning signs:** Creator sees duplicate "welcome to project" messages in Discord.

**Prevention:**
```typescript
// In POST /api/projects/[id]/join
if (creatorDiscordUsername && project.discordChannelId) {
  // Creator already has Discord access from approval
  // No need to add again - just send join message
  try {
    await sendChannelMessage(
      project.discordChannelId,
      `üëã ${creatorMention} (creator) has joined the project as a team member!`
    );
  } catch (error) {
    console.error("Discord message failed:", error);
  }
}
```

### Pitfall 2: UI Showing Creator in Two Places

**What goes wrong:** TeamRoster shows creator card separately, AND creator appears in members array after joining, resulting in duplicate display.

**Why it happens:** UI always renders creator from `project.creatorProfile`, AND loops through `members` array which now includes creator.

**How to avoid:** Filter creator out of members array before rendering.

```typescript
// In TeamRoster.tsx
const nonCreatorMembers = members.filter(m => m.userId !== project.creatorId);

// Render creator card
// Render nonCreatorMembers
```

**Warning signs:** Creator appears twice in team roster with different badges.

### Pitfall 3: Off-by-One Error in Team Size Limit

**What goes wrong:** Team hits max size, creator can't join even though `memberCount < maxTeamSize`.

**Why it happens:** UI counts creator in total (`members.length + 1`), but Firestore `memberCount` only counts ProjectMember docs. If creator tries to join when `memberCount === maxTeamSize - 1`, enforcement logic sees it as "at capacity."

**How to avoid:** Enforce limit based on ProjectMember count only, not UI display count.

```typescript
// In POST /api/projects/[id]/join
const membersSnapshot = await db
  .collection("project_members")
  .where("projectId", "==", projectId)
  .count()
  .get();
const currentMemberCount = membersSnapshot.data().count;

if (project.maxTeamSize && currentMemberCount >= project.maxTeamSize) {
  return NextResponse.json(
    { error: "Team is full." },
    { status: 409 }
  );
}
```

**Warning signs:** Creator sees "team is full" error when UI shows 1 slot open.

### Pitfall 4: Permission Confusion After Creator Leaves

**What goes wrong:** Creator leaves project as member, tries to manage team, gets "permission denied" error.

**Why it happens:** Frontend checks `isMember` for showing management UI, not `isOwner`.

**How to avoid:** Use `canManageProjectMembers` permission check, which checks owner OR admin.

```typescript
// In ProjectDetailPage.tsx
const canManage = useMemo(() => {
  if (!user || !project || !profile) return false;

  const permissionUser: PermissionUser = {
    uid: user.uid,
    role: profile.role,
    status: profile.status,
    isAdmin: profile.isAdmin,
  };

  return canManageProjectMembers(permissionUser, project);
}, [user, project, profile]);

// Show management UI based on canManage, not isCreator
```

**Warning signs:** Creator can't see "Remove" buttons after leaving as member.

## State of the Art

### Permission System Evolution

| Old Approach | Current Approach | Impact |
|--------------|------------------|--------|
| Role-based project creation (mentor-only) | Authentication-based project creation (any user) | Democratizes project creation, aligns with product vision |
| Creator automatically in team | Creator separate from team membership | Clearer separation of concerns, flexible participation |
| Implicit Discord access for creator | Explicit membership required for Discord | Consistent Discord permission model |

### Best Practices from Codebase

**Pattern: Composite keys for relationships**
- ProjectMember: `{projectId}_{userId}`
- ProjectApplication: `{projectId}_{userId}`
- Prevents duplicates, enables direct document access

**Pattern: Denormalized profile subsets**
- `creatorProfile` in Project document
- `userProfile` in ProjectMember document
- Avoids N+1 queries when rendering lists

**Pattern: Batch writes for atomicity**
- Application approval updates 3 documents in single batch
- Leave operation deletes member + application + updates project
- Ensures data consistency

**Pattern: Non-blocking Discord operations**
- Discord API calls after Firestore commit
- Log errors but don't throw/rollback
- System remains functional if Discord is down

## Open Questions

### 1. Should creator get automatic Discord access on approval?

**What we know:** Current implementation grants Discord access during `createProjectChannel` call on project approval (src/lib/discord.ts line 1005-1014). This happens before creator explicitly joins.

**What's unclear:** Is this desired behavior or a bug?

**Recommendation:** Keep current behavior for MVP. Creator gets Discord access on approval (they created the project, they should set it up). If creator later leaves as member, Discord permissions are removed via existing `removeMemberFromChannel` logic.

**Rationale:** Simpler implementation. Creator typically wants to manage Discord channel setup (pin messages, set topic, etc.) even if they don't plan to stay as an active member.

### 2. What happens to projects when creator account is deleted?

**What we know:** No cascade delete logic exists. `project.creatorId` would point to non-existent UID.

**What's unclear:** Should projects be auto-archived? Transferred to admin? Marked as orphaned?

**Recommendation:** Out of scope for this phase. Document as known limitation. Address in future user management phase.

### 3. Should we add a "Transfer Ownership" feature?

**What we know:** Current system has permanent `creatorId`. No ownership transfer mechanism.

**What's unclear:** Is this needed for MVP?

**Recommendation:** Out of scope for Phase 6.1. Current limitation: creator cannot transfer ownership. Document in user-facing docs as "Project creator cannot be changed."

**Future consideration:** Add `PUT /api/projects/[id]/transfer` endpoint with permission check for creator-only. Update `creatorId` and `creatorProfile`, send notifications.

## Sources

### Primary (HIGH confidence)

**Codebase files analyzed:**
- `src/lib/permissions.ts` - Current permission logic (lines 102-104)
- `src/app/api/projects/route.ts` - Project creation flow (lines 87-103)
- `src/app/api/projects/[id]/route.ts` - Approval flow, Discord channel creation (lines 105-134)
- `src/app/api/projects/[id]/applications/[userId]/route.ts` - Application approval flow (lines 76-108)
- `src/app/api/projects/[id]/leave/route.ts` - Leave project flow (lines 35-42)
- `src/lib/discord.ts` - Discord integration (lines 961-1078, 1182-1269)
- `src/components/projects/TeamRoster.tsx` - UI representation (lines 21, 30-52)
- `src/types/mentorship.ts` - Data types (lines 121-160)

**Project documentation:**
- `.planning/STATE.md` - Prior architectural decisions
- Phase context provided by orchestrator

### Secondary (MEDIUM confidence)

**Inferred patterns:**
- Firestore security rules structure (not directly inspected, but referenced in code comments)
- Permission test file location (assumed `src/lib/__tests__/permissions.test.ts` based on standard project structure)

### Tertiary (LOW confidence)

None - all findings verified through direct code inspection.

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - Using existing codebase patterns (Next.js API routes, Firestore batch writes, Discord integration)
- Architecture: HIGH - Direct code inspection confirms current behavior and required changes
- Pitfalls: HIGH - Identified from analyzing interaction between components (Discord, Firestore, UI)

**Research date:** 2026-02-11
**Valid until:** 30 days (stable codebase, no external dependencies changing)

**Research completeness:**
- ‚úÖ Current permission system analyzed
- ‚úÖ Project creation flow traced
- ‚úÖ Discord integration behavior documented
- ‚úÖ UI rendering logic understood
- ‚úÖ Data model structure mapped
- ‚úÖ Required changes identified with specific file/line references
- ‚úÖ Common pitfalls catalogued with prevention strategies
- ‚úÖ Open questions documented with recommendations
