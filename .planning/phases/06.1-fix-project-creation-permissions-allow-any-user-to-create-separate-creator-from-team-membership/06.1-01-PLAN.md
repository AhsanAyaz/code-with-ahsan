---
phase: 06.1-fix-project-creation-permissions-allow-any-user-to-create-separate-creator-from-team-membership
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/permissions.ts
  - src/__tests__/permissions.test.ts
  - firestore.rules
  - src/app/api/projects/route.ts
autonomous: true

must_haves:
  truths:
    - "Any authenticated user (mentor, mentee, pending) can create projects"
    - "Unauthenticated users cannot create projects"
    - "Non-mentor project creators can edit their own projects and manage members"
    - "Firestore security rules allow any signed-in user to create projects"
    - "All permission tests pass with updated expectations"
  artifacts:
    - path: "src/lib/permissions.ts"
      provides: "Updated canCreateProject using isAuthenticated, updated canOwnerOrAdminAccess using isOwner without mentor check"
      contains: "isAuthenticated"
    - path: "src/__tests__/permissions.test.ts"
      provides: "Updated test expectations for any-user project creation and owner-based management"
      contains: "returns true for mentee"
    - path: "firestore.rules"
      provides: "Updated project create rule using isSignedIn instead of isAcceptedMentor"
      contains: "allow create: if isSignedIn()"
    - path: "src/app/api/projects/route.ts"
      provides: "Updated error message for permission denial"
      contains: "Only authenticated users can create projects"
  key_links:
    - from: "src/app/api/projects/route.ts"
      to: "src/lib/permissions.ts"
      via: "canCreateProject import"
      pattern: "canCreateProject\\(permissionUser\\)"
    - from: "src/lib/permissions.ts"
      to: "canOwnerOrAdminAccess"
      via: "internal helper used by canEditProject, canManageProjectMembers"
      pattern: "canOwnerOrAdminAccess"
---

<objective>
Fix the core permission logic so any authenticated user can create projects, and non-mentor creators can manage their own projects.

Purpose: The current system incorrectly restricts project creation to accepted mentors only (PERM-01 bug). Additionally, the `canOwnerOrAdminAccess` helper requires `isAcceptedMentor` for owner checks, which means a non-mentor creator could not edit or manage their own project. Both must be fixed together.

Output: Updated permission functions, Firestore rules, permission tests, and API error message.
</objective>

<execution_context>
@/Users/amu1o5/.claude/get-shit-done/workflows/execute-plan.md
@/Users/amu1o5/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06.1-fix-project-creation-permissions-allow-any-user-to-create-separate-creator-from-team-membership/06.1-RESEARCH.md
@src/lib/permissions.ts
@src/__tests__/permissions.test.ts
@firestore.rules
@src/app/api/projects/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix permission functions and Firestore rules</name>
  <files>
    src/lib/permissions.ts
    firestore.rules
    src/app/api/projects/route.ts
  </files>
  <action>
In `src/lib/permissions.ts`:

1. Update the module docstring comment for PERM-01 from "Only accepted mentors can create projects" to "Any authenticated user can create projects".

2. Change `canCreateProject` (line 102-104) from:
```typescript
export function canCreateProject(user: PermissionUser | null): boolean {
  return isAcceptedMentor(user);
}
```
To:
```typescript
export function canCreateProject(user: PermissionUser | null): boolean {
  return isAuthenticated(user);
}
```

3. Update the JSDoc comment above `canCreateProject` from "Only accepted mentors can create projects" to "Any authenticated user can create projects".

4. **CRITICAL FIX:** Change `canOwnerOrAdminAccess` (line 87-94) from:
```typescript
function canOwnerOrAdminAccess(
  user: PermissionUser | null,
  resource: { creatorId: string }
): boolean {
  if (isAdminUser(user)) return true;
  if (isAcceptedMentor(user) && isOwner(user, resource)) return true;
  return false;
}
```
To:
```typescript
function canOwnerOrAdminAccess(
  user: PermissionUser | null,
  resource: { creatorId: string }
): boolean {
  if (isAdminUser(user)) return true;
  if (isAuthenticated(user) && isOwner(user, resource)) return true;
  return false;
}
```
This ensures any authenticated user who owns a resource can edit/manage it, not just accepted mentors. Without this fix, a mentee who creates a project would be unable to manage their own project.

5. Update the JSDoc comments for `canEditProject` and `canManageProjectMembers` to reflect "Only project creator or admin" instead of "Only project creator (if accepted mentor) or admin".

In `firestore.rules`:

6. Change the projects create rule (line 34-38) from:
```
// PERM-01: Only accepted mentors can create projects
allow create: if isAcceptedMentor() &&
                 request.resource.data.creatorId == request.auth.uid &&
                 request.resource.data.status == "pending";
```
To:
```
// Any authenticated user can create projects
allow create: if isSignedIn() &&
                 request.resource.data.creatorId == request.auth.uid &&
                 request.resource.data.status == "pending";
```

In `src/app/api/projects/route.ts`:

7. Update the error message in the permission denial response (line 97-102) from:
```typescript
{
  error: "Permission denied",
  message: "Only accepted mentors can create projects",
}
```
To:
```typescript
{
  error: "Permission denied",
  message: "Only authenticated users can create projects",
}
```

8. Update the inline comment on line 87 from "Check permission: only accepted mentors can create projects" to "Check permission: only authenticated users can create projects".
  </action>
  <verify>
Run `npx vitest run src/__tests__/permissions.test.ts` — tests WILL fail because test expectations haven't been updated yet. Verify that:
- canCreateProject tests for mentee and pending mentor now return true (these are the failures we expect)
- canEditProject and canManageProjectMembers tests for non-mentor owners now return true (these will also change)
This confirms the permission logic changes are applied correctly.

Additionally, verify the error message was updated:
- `grep 'Only authenticated users can create projects' src/app/api/projects/route.ts` — should find the updated error message
  </verify>
  <done>
- `canCreateProject` returns `isAuthenticated(user)` instead of `isAcceptedMentor(user)`
- `canOwnerOrAdminAccess` checks `isAuthenticated(user) && isOwner(user, resource)` instead of `isAcceptedMentor(user) && isOwner(user, resource)`
- Firestore rules use `isSignedIn()` for project creation instead of `isAcceptedMentor()`
- API error message updated to "Only authenticated users can create projects"
- All inline comments updated to "only authenticated users" (not "any authenticated user")
  </done>
</task>

<task type="auto">
  <name>Task 2: Update permission tests for new authorization model</name>
  <files>src/__tests__/permissions.test.ts</files>
  <action>
Update `src/__tests__/permissions.test.ts` to reflect the new permission model:

**canCreateProject (PERM-01) tests — update the describe block:**

1. Update test description from "canCreateProject (PERM-01)" to reflect new behavior.

2. Keep "returns true for admin" test as-is (still passes).

3. Keep "returns true for accepted mentor" test as-is (still passes).

4. Change "returns false for pending mentor" to "returns true for pending mentor":
```typescript
it("returns true for pending mentor", () => {
  expect(canCreateProject(pendingMentor)).toBe(true);
});
```

5. Change "returns false for mentee" to "returns true for mentee":
```typescript
it("returns true for mentee", () => {
  expect(canCreateProject(mentee)).toBe(true);
});
```

6. Keep "returns false for null user" test as-is (still passes).

**canEditProject (PERM-04) tests — update affected cases:**

7. Change "returns false for pending mentor (owner)" to expect true:
```typescript
it("returns true for pending mentor (owner)", () => {
  const pendingOwned = { ...testProject, creatorId: pendingMentor.uid };
  expect(canEditProject(pendingMentor, pendingOwned)).toBe(true);
});
```

8. Add a new test for mentee as owner:
```typescript
it("returns true for mentee (owner)", () => {
  const menteeOwned = { ...testProject, creatorId: mentee.uid };
  expect(canEditProject(mentee, menteeOwned)).toBe(true);
});
```

9. Keep "returns false for mentee" test (non-owner) — still false.

**canManageProjectMembers (PERM-04) tests — update affected cases:**

10. Change "returns false for pending mentor (owner)" to expect true:
```typescript
it("returns true for pending mentor (owner)", () => {
  const pendingOwned = { ...testProject, creatorId: pendingMentor.uid };
  expect(canManageProjectMembers(pendingMentor, pendingOwned)).toBe(true);
});
```

11. Add a new test for mentee as owner:
```typescript
it("returns true for mentee (owner)", () => {
  const menteeOwned = { ...testProject, creatorId: mentee.uid };
  expect(canManageProjectMembers(mentee, menteeOwned)).toBe(true);
});
```

**canEditRoadmap tests — update affected cases:**

12. Change "returns false for pending mentor (owner)" to expect true:
```typescript
it("returns true for pending mentor (owner)", () => {
  const pendingOwned = { ...testRoadmap, creatorId: pendingMentor.uid };
  expect(canEditRoadmap(pendingMentor, pendingOwned)).toBe(true);
});
```

13. Add a new test for mentee as roadmap owner:
```typescript
it("returns true for mentee (owner)", () => {
  const menteeOwned = { ...testRoadmap, creatorId: mentee.uid };
  expect(canEditRoadmap(mentee, menteeOwned)).toBe(true);
});
```

Note: Although roadmap creation remains mentor-only, if a roadmap somehow has a non-mentor owner, they should still be able to edit it. The `canOwnerOrAdminAccess` change is consistent across all resources.
  </action>
  <verify>
Run `npx vitest run src/__tests__/permissions.test.ts` — ALL tests must pass. Expected count should increase from 50 to ~56 tests (2 tests change from false to true, 6 new test cases added: 4 existing test descriptions updated from "returns false" to "returns true" + 2 new owner tests for canEditProject + 2 new owner tests for canManageProjectMembers + 2 new owner tests for canEditRoadmap).
  </verify>
  <done>
- All permission tests pass
- canCreateProject allows any authenticated user (admin, mentor, pending mentor, mentee) but blocks null
- canEditProject and canManageProjectMembers allow any authenticated owner (not just accepted mentors)
- canEditRoadmap allows any authenticated owner
- Test count increased to ~56 tests (2 changed expectations + 6 new tests)
  </done>
</task>

</tasks>

<verification>
1. `npx vitest run src/__tests__/permissions.test.ts` — all tests pass (including new test cases)
2. Grep `src/lib/permissions.ts` for `isAcceptedMentor` — should only appear in `isAcceptedMentor` function definition and `canCreateRoadmap` (roadmap creation stays mentor-only)
3. Grep `firestore.rules` for `isAcceptedMentor` — should only appear in the function definition and roadmaps create rule
4. `src/app/api/projects/route.ts` error message says "Only authenticated users"
5. Grep `src/app/api/projects/route.ts` for "Only authenticated users can create projects" — should find the error message
</verification>

<success_criteria>
- Any authenticated user can create projects (permission function + Firestore rule + API route)
- Any authenticated project owner can edit/manage their project (not just mentors)
- All 56 permission tests pass
- Roadmap creation remains mentor-only (no regression)
- Consistent wording: "only authenticated users" in all comments and messages
</success_criteria>

<output>
After completion, create `.planning/phases/06.1-fix-project-creation-permissions-allow-any-user-to-create-separate-creator-from-team-membership/06.1-01-SUMMARY.md`
</output>
