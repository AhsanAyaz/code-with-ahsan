---
phase: 12-mentor-time-slots-weekly-availability-management-mentee-booking-rescheduling-google-calendar-integration
plan: 05
type: execute
wave: 3
depends_on: ["12-02"]
files_modified:
  - src/components/mentorship/TimeSlotPicker.tsx
  - src/components/mentorship/BookingsList.tsx
  - src/app/mentorship/book/[mentorId]/page.tsx
  - src/app/mentorship/book/[mentorId]/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Mentee can view available time slots for a mentor organized by date"
    - "Mentee can select and confirm a 30-minute booking slot"
    - "Both mentor and mentee can see their upcoming and past bookings"
    - "Booking page is accessible from the mentor's public profile"
  artifacts:
    - path: "src/components/mentorship/TimeSlotPicker.tsx"
      provides: "Date selector and time slot grid for booking"
      contains: "TimeSlotPicker"
    - path: "src/components/mentorship/BookingsList.tsx"
      provides: "List of bookings with cancel action"
      contains: "BookingsList"
    - path: "src/app/mentorship/book/[mentorId]/page.tsx"
      provides: "Booking page for a specific mentor"
      contains: "BookMentorPage"
    - path: "src/app/mentorship/book/[mentorId]/layout.tsx"
      provides: "Layout with MentorshipProvider"
      contains: "MentorshipProvider"
  key_links:
    - from: "src/components/mentorship/TimeSlotPicker.tsx"
      to: "/api/mentorship/time-slots"
      via: "fetches available slots"
      pattern: "fetch.*api/mentorship/time-slots"
    - from: "src/components/mentorship/TimeSlotPicker.tsx"
      to: "/api/mentorship/bookings"
      via: "POST to create booking"
      pattern: "fetch.*api/mentorship/bookings"
    - from: "src/components/mentorship/BookingsList.tsx"
      to: "/api/mentorship/bookings"
      via: "GET to fetch bookings, PUT to cancel"
      pattern: "fetch.*api/mentorship/bookings"
---

<objective>
Build the mentee-facing booking UI: a time slot picker for selecting and booking available slots, a bookings list for viewing/cancelling upcoming sessions, and the booking page route.

Purpose: Complete the mentee experience for discovering and booking mentor time slots, and viewing their bookings.
Output: TimeSlotPicker component, BookingsList component, booking page at /mentorship/book/[mentorId].
</objective>

<execution_context>
@/home/ahsan/.claude/get-shit-done/workflows/execute-plan.md
@/home/ahsan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-mentor-time-slots-weekly-availability-management-mentee-booking-rescheduling-google-calendar-integration/12-01-SUMMARY.md
@.planning/phases/12-mentor-time-slots-weekly-availability-management-mentee-booking-rescheduling-google-calendar-integration/12-02-SUMMARY.md
@src/types/mentorship.ts
@src/lib/apiClient.ts
@src/contexts/MentorshipContext.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TimeSlotPicker and BookingsList components</name>
  <files>src/components/mentorship/TimeSlotPicker.tsx, src/components/mentorship/BookingsList.tsx</files>
  <action>
**Create `src/components/mentorship/TimeSlotPicker.tsx`:**

"use client" component for selecting and booking time slots.

Props:
```typescript
interface TimeSlotPickerProps {
  mentorId: string;
  mentorName: string;
  onBookingComplete?: (bookingId: string) => void;
}
```

State:
- `selectedDate`: Date | null (the date selected from the date navigator)
- `slots`: Record<string, AvailableSlot[]> (date string -> slots, from API)
- `loading`: boolean
- `selectedSlot`: AvailableSlot | null
- `booking`: boolean (loading state for booking action)
- `error`: string | null
- `startDate`: Date (start of the current 7-day viewing window)

UI Layout:
```
<div className="card bg-base-100 shadow-xl">
  <div className="card-body">
    <h3 className="card-title">Book a Session with {mentorName}</h3>
    <p className="text-sm opacity-70">30-minute mentorship sessions</p>

    {/* Date Navigator - show 7 days at a time */}
    <div className="flex items-center gap-2 my-4">
      <button className="btn btn-sm btn-ghost" onClick={prevWeek}>&lt;</button>
      <div className="flex gap-1 flex-wrap">
        {7 days from startDate}.map(date => (
          <button
            className={`btn btn-sm ${isSelected ? 'btn-primary' : 'btn-ghost'} ${hasSlots ? '' : 'btn-disabled opacity-50'}`}
            onClick={() => setSelectedDate(date)}
          >
            <div className="text-center">
              <div className="text-xs">{dayAbbr}</div>  {/* Mon, Tue, etc. */}
              <div className="font-bold">{dayNum}</div>  {/* 15, 16, etc. */}
            </div>
          </button>
        ))
      </div>
      <button className="btn btn-sm btn-ghost" onClick={nextWeek}>&gt;</button>
    </div>

    {/* Available Slots Grid */}
    {loading ? (
      <div className="flex justify-center py-8">
        <span className="loading loading-spinner loading-lg"></span>
      </div>
    ) : selectedDate && slotsForSelectedDate.length > 0 ? (
      <div className="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-2">
        {slotsForSelectedDate.map(slot => (
          <button
            className={`btn btn-sm ${selectedSlot === slot ? 'btn-primary' : 'btn-outline'}`}
            onClick={() => setSelectedSlot(slot)}
          >
            {slot.displayTime}
          </button>
        ))}
      </div>
    ) : selectedDate ? (
      <p className="text-center py-4 opacity-60">No available slots for this date.</p>
    ) : (
      <p className="text-center py-4 opacity-60">Select a date to see available slots.</p>
    )}

    {/* Booking Confirmation */}
    {selectedSlot && (
      <div className="mt-4 p-4 bg-base-200 rounded-lg">
        <p className="font-medium">Confirm Booking</p>
        <p className="text-sm">
          {formatDate(selectedSlot.start)} at {selectedSlot.displayTime} (30 minutes)
        </p>
        <div className="mt-3 flex gap-2">
          <button className="btn btn-primary btn-sm" onClick={handleBook} disabled={booking}>
            {booking ? <span className="loading loading-spinner loading-sm"></span> : "Confirm Booking"}
          </button>
          <button className="btn btn-ghost btn-sm" onClick={() => setSelectedSlot(null)}>Cancel</button>
        </div>
      </div>
    )}

    {error && <div className="alert alert-error mt-4"><span>{error}</span></div>}
  </div>
</div>
```

Data fetching:
- On mount and when startDate changes, fetch slots for 7-day window:
  ```typescript
  const fetchSlots = async () => {
    setLoading(true);
    const start = format(startDate, "yyyy-MM-dd");
    const end = format(addDays(startDate, 6), "yyyy-MM-dd");
    const res = await fetch(`/api/mentorship/time-slots?mentorId=${mentorId}&startDate=${start}&endDate=${end}`);
    const data = await res.json();
    setSlots(data.slots || {});
    setLoading(false);
  };
  ```

Booking handler:
```typescript
const handleBook = async () => {
  if (!selectedSlot) return;
  setBooking(true);
  setError(null);
  try {
    const res = await authFetch("/api/mentorship/bookings", {
      method: "POST",
      body: JSON.stringify({
        mentorId,
        startTime: selectedSlot.start,
        endTime: selectedSlot.end,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
      }),
    });
    if (res.status === 409) {
      setError("This slot was just booked by someone else. Please choose another.");
      // Refresh slots
      fetchSlots();
    } else if (!res.ok) {
      const data = await res.json();
      setError(data.error || "Failed to book session");
    } else {
      const data = await res.json();
      onBookingComplete?.(data.booking?.id);
      toast.success("Session booked successfully!");
      setSelectedSlot(null);
      fetchSlots(); // Refresh to remove booked slot
    }
  } catch {
    setError("Failed to book session. Please try again.");
  } finally {
    setBooking(false);
  }
};
```

Use `authFetch` from `@/lib/apiClient`. Use `useToast` from `@/contexts/ToastContext`. Import date-fns `format`, `addDays` for date formatting.

**Create `src/components/mentorship/BookingsList.tsx`:**

"use client" component showing a user's bookings with cancel functionality.

Props:
```typescript
interface BookingsListProps {
  userId: string;
  role: "mentor" | "mentee";
}
```

State:
- `bookings`: MentorBooking[]
- `loading`: boolean
- `cancellingId`: string | null

UI Layout:
```
<div className="card bg-base-100 shadow-xl">
  <div className="card-body">
    <h3 className="card-title">
      {role === "mentor" ? "Mentee Bookings" : "My Bookings"}
    </h3>

    {loading ? (
      <span className="loading loading-spinner"></span>
    ) : bookings.length === 0 ? (
      <p className="opacity-60">No upcoming bookings.</p>
    ) : (
      <div className="space-y-3">
        {bookings.map(booking => {
          const partner = role === "mentor" ? booking.menteeProfile : booking.mentorProfile;
          const isPast = new Date(booking.startTime) < new Date();
          return (
            <div className={`flex items-center justify-between p-3 rounded-lg ${isPast ? 'bg-base-200 opacity-60' : 'bg-base-200'}`}>
              <div className="flex items-center gap-3">
                {partner?.photoURL && <img src={partner.photoURL} className="w-8 h-8 rounded-full" />}
                <div>
                  <p className="font-medium">{partner?.displayName || "Unknown"}</p>
                  <p className="text-sm opacity-70">
                    {formatDate(booking.startTime)} at {formatTime(booking.startTime)}
                  </p>
                </div>
              </div>
              <div className="flex items-center gap-2">
                {booking.status === "cancelled" ? (
                  <span className="badge badge-error badge-sm">Cancelled</span>
                ) : isPast ? (
                  <span className="badge badge-ghost badge-sm">Completed</span>
                ) : (
                  <button
                    className="btn btn-xs btn-ghost text-error"
                    onClick={() => handleCancel(booking.id)}
                    disabled={cancellingId === booking.id}
                  >
                    {cancellingId === booking.id ? (
                      <span className="loading loading-spinner loading-xs"></span>
                    ) : "Cancel"}
                  </button>
                )}
              </div>
            </div>
          );
        })}
      </div>
    )}
  </div>
</div>
```

Fetch bookings on mount:
```typescript
useEffect(() => {
  authFetch(`/api/mentorship/bookings?userId=${userId}&role=${role}&status=all`)
    .then(res => res.json())
    .then(data => setBookings(data.bookings || []))
    .finally(() => setLoading(false));
}, [userId, role]);
```

Cancel handler:
```typescript
const handleCancel = async (bookingId: string) => {
  if (!confirm("Are you sure you want to cancel this booking?")) return;
  setCancellingId(bookingId);
  try {
    const res = await authFetch("/api/mentorship/bookings", {
      method: "PUT",
      body: JSON.stringify({ bookingId, action: "cancel" }),
    });
    if (res.ok) {
      setBookings(prev => prev.map(b => b.id === bookingId ? { ...b, status: "cancelled" as const } : b));
      toast.success("Booking cancelled.");
    }
  } catch {
    toast.error("Failed to cancel booking.");
  } finally {
    setCancellingId(null);
  }
};
```
  </action>
  <verify>
Run `npx tsc --noEmit` to verify both components compile. Check that all imports resolve.
  </verify>
  <done>
TimeSlotPicker shows 7-day date navigator with available slot grid, handles slot selection and booking confirmation with 409 conflict handling. BookingsList shows upcoming/past bookings with cancel action. Both use DaisyUI styling and authFetch for authenticated requests.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create booking page route and add booking link to mentor profiles</name>
  <files>src/app/mentorship/book/[mentorId]/page.tsx, src/app/mentorship/book/[mentorId]/layout.tsx</files>
  <action>
**Create `src/app/mentorship/book/[mentorId]/layout.tsx`:**

Follow the MentorshipProvider layout pattern used by /profile and /projects:
```typescript
import { MentorshipProvider } from "@/contexts/MentorshipContext";

export default function BookLayout({ children }: { children: React.ReactNode }) {
  return (
    <MentorshipProvider>
      <div className="min-h-screen bg-base-200">
        <main className="max-w-4xl mx-auto px-4 py-8">{children}</main>
      </div>
    </MentorshipProvider>
  );
}
```

Add metadata export:
```typescript
import type { Metadata } from "next";
export const metadata: Metadata = {
  title: "Book a Session | Code with Ahsan",
  description: "Book a mentorship session with a mentor.",
};
```

**Create `src/app/mentorship/book/[mentorId]/page.tsx`:**

"use client" page that displays mentor info and the booking interface.

```typescript
"use client";

import { useState, useEffect, use } from "react";
import { useMentorship } from "@/contexts/MentorshipContext";
import { useToast } from "@/contexts/ToastContext";
import TimeSlotPicker from "@/components/mentorship/TimeSlotPicker";
import BookingsList from "@/components/mentorship/BookingsList";
import Link from "next/link";

export default function BookMentorPage({ params }: { params: Promise<{ mentorId: string }> }) {
  const { mentorId } = use(params);
  const { user, profile, loading } = useMentorship();
  const toast = useToast();
  const [mentor, setMentor] = useState<any>(null);
  const [mentorLoading, setMentorLoading] = useState(true);
  const [bookingComplete, setBookingComplete] = useState(false);

  // Fetch mentor profile
  useEffect(() => {
    fetch(`/api/mentorship/mentors/${mentorId}`)  // Need to check if this endpoint exists by username or ID
      .then(res => res.ok ? res.json() : null)
      .then(data => {
        if (data?.mentor) setMentor(data.mentor);
      })
      .catch(console.error)
      .finally(() => setMentorLoading(false));
  }, [mentorId]);
```

Actually, check the existing mentor profile API. The app has `/api/mentorship/mentors/[username]` which fetches by username. But we're routing by mentorId (uid). We need to fetch mentor by uid, not username. The simplest approach: use the existing GET profile endpoint or create a simple fetch.

Let me adjust: The booking page will receive mentorId as the uid. To get mentor display info, fetch from `/api/mentorship/profile?uid={mentorId}` (the existing endpoint).

Continue:
```typescript
  useEffect(() => {
    fetch(`/api/mentorship/profile?uid=${mentorId}`)
      .then(res => res.ok ? res.json() : null)
      .then(data => {
        if (data) setMentor(data);
      })
      .catch(console.error)
      .finally(() => setMentorLoading(false));
  }, [mentorId]);

  if (loading || mentorLoading) {
    return (
      <div className="flex justify-center py-20">
        <span className="loading loading-spinner loading-lg"></span>
      </div>
    );
  }

  if (!mentor) {
    return (
      <div className="text-center py-20">
        <h2 className="text-xl font-semibold">Mentor not found</h2>
        <Link href="/mentorship" className="btn btn-primary mt-4">Browse Mentors</Link>
      </div>
    );
  }

  if (!user) {
    return (
      <div className="text-center py-20">
        <h2 className="text-xl font-semibold">Please log in to book a session</h2>
      </div>
    );
  }

  if (user.uid === mentorId) {
    return (
      <div className="text-center py-20">
        <h2 className="text-xl font-semibold">You cannot book a session with yourself</h2>
        <Link href="/profile" className="btn btn-primary mt-4">Manage Your Availability</Link>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Mentor Info Header */}
      <div className="card bg-base-100 shadow-xl">
        <div className="card-body flex-row items-center gap-4">
          {mentor.photoURL && (
            <img src={mentor.photoURL} alt={mentor.displayName} className="w-16 h-16 rounded-full" />
          )}
          <div>
            <h2 className="card-title">{mentor.displayName}</h2>
            {mentor.currentRole && <p className="text-sm opacity-70">{mentor.currentRole}</p>}
            {mentor.expertise?.length > 0 && (
              <div className="flex gap-1 mt-1 flex-wrap">
                {mentor.expertise.map((skill: string) => (
                  <span key={skill} className="badge badge-sm badge-outline">{skill}</span>
                ))}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Booking Success Message */}
      {bookingComplete && (
        <div className="alert alert-success">
          <span>Session booked! Check your bookings below.</span>
        </div>
      )}

      {/* Time Slot Picker */}
      <TimeSlotPicker
        mentorId={mentorId}
        mentorName={mentor.displayName}
        onBookingComplete={() => setBookingComplete(true)}
      />

      {/* My Bookings with this mentor */}
      <BookingsList userId={user.uid} role="mentee" />
    </div>
  );
}
```

Note: The mentorId in the route is the mentor's uid, not username. This is deliberate because:
1. The time-slots and bookings APIs work with uid
2. Username might not always be set
3. The link from mentor profile card will use uid

Also, find where the mentor public profile or MentorCard component links are rendered to add a "Book Session" button/link pointing to `/mentorship/book/{mentorId}`. Search for the mentor profile page or MentorCard component. If there's a public mentor profile at `/mentorship/mentors/[username]`, add a "Book Session" link there that navigates to `/mentorship/book/{mentor.uid}`. But this can be done as a small addition - check what exists and add the link if the component is found.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify compilation. Run `npm run build` to verify the page route compiles. Navigate to /mentorship/book/{test-uid} in dev to verify it renders.
  </verify>
  <done>
Booking page at /mentorship/book/[mentorId] shows mentor info header, TimeSlotPicker for selecting and confirming slots, and BookingsList for viewing existing bookings. Page handles loading states, mentor not found, unauthenticated users, and self-booking prevention. MentorshipProvider layout wraps the route.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds
3. /mentorship/book/[mentorId] route renders correctly
4. TimeSlotPicker fetches and displays available slots
5. Booking confirmation creates booking via POST
6. BookingsList shows user's bookings with cancel action
7. 409 conflict displays user-friendly error and refreshes slots
</verification>

<success_criteria>
- Mentee can navigate to /mentorship/book/{mentorId}
- Date navigator shows 7 days with slot availability indicators
- Selecting a date shows available time slots as buttons
- Clicking a slot shows confirmation panel
- Confirming creates a booking (or shows conflict error)
- BookingsList shows upcoming and past bookings
- Cancel button on active bookings works
- Loading, empty, and error states handled
</success_criteria>

<output>
After completion, create `.planning/phases/12-mentor-time-slots-weekly-availability-management-mentee-booking-rescheduling-google-calendar-integration/12-05-SUMMARY.md`
</output>
