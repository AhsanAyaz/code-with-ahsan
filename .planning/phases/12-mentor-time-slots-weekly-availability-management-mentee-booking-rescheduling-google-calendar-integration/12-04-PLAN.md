---
phase: 12-mentor-time-slots-weekly-availability-management-mentee-booking-rescheduling-google-calendar-integration
plan: 04
type: execute
wave: 3
depends_on: ["12-01", "12-03"]
files_modified:
  - src/components/mentorship/AvailabilityManager.tsx
  - src/components/mentorship/OverrideDatesManager.tsx
  - src/app/profile/page.tsx
autonomous: true

must_haves:
  truths:
    - "Mentor can set weekly availability time ranges for each day of the week"
    - "Mentor can add and remove override dates when they are unavailable"
    - "Mentor can connect their Google Calendar via OAuth button"
    - "Availability settings persist after save and reload"
  artifacts:
    - path: "src/components/mentorship/AvailabilityManager.tsx"
      provides: "Weekly availability editor with day-by-day time range inputs"
      contains: "AvailabilityManager"
    - path: "src/components/mentorship/OverrideDatesManager.tsx"
      provides: "Override dates add/remove interface"
      contains: "OverrideDatesManager"
    - path: "src/app/profile/page.tsx"
      provides: "Profile page with availability section for mentors"
      contains: "AvailabilityManager"
  key_links:
    - from: "src/components/mentorship/AvailabilityManager.tsx"
      to: "/api/mentorship/availability"
      via: "fetch PUT to save availability"
      pattern: "fetch.*api/mentorship/availability"
    - from: "src/app/profile/page.tsx"
      to: "src/components/mentorship/AvailabilityManager.tsx"
      via: "renders AvailabilityManager for mentor role"
      pattern: "AvailabilityManager"
    - from: "src/app/profile/page.tsx"
      to: "/api/mentorship/calendar/auth"
      via: "fetch to get Google OAuth URL"
      pattern: "api/mentorship/calendar/auth"
---

<objective>
Build the mentor-facing UI for managing weekly time slot availability, override dates, and Google Calendar connection. Integrate into the existing profile page.

Purpose: Give mentors a visual interface to define when they're available for 30-minute mentoring sessions each week, block specific dates, and optionally connect Google Calendar.
Output: AvailabilityManager component, OverrideDatesManager component, updated profile page.
</objective>

<execution_context>
@/home/ahsan/.claude/get-shit-done/workflows/execute-plan.md
@/home/ahsan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-mentor-time-slots-weekly-availability-management-mentee-booking-rescheduling-google-calendar-integration/12-01-SUMMARY.md
@.planning/phases/12-mentor-time-slots-weekly-availability-management-mentee-booking-rescheduling-google-calendar-integration/12-03-SUMMARY.md
@src/app/profile/page.tsx
@src/app/profile/layout.tsx
@src/types/mentorship.ts
@src/lib/apiClient.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AvailabilityManager and OverrideDatesManager components</name>
  <files>src/components/mentorship/AvailabilityManager.tsx, src/components/mentorship/OverrideDatesManager.tsx</files>
  <action>
**Create `src/components/mentorship/AvailabilityManager.tsx`:**

A "use client" component that provides a full weekly availability editor.

Props:
```typescript
interface AvailabilityManagerProps {
  userId: string;
  initialAvailability?: TimeSlotAvailability;
  initialUnavailableDates?: UnavailableDate[];
  isCalendarConnected?: boolean;
  onCalendarConnect?: () => void;
}
```

State:
- `weekly`: `Partial<Record<DayOfWeek, TimeRange[]>>` initialized from props
- `timezone`: string initialized from `Intl.DateTimeFormat().resolvedOptions().timeZone` or from props
- `saving`: boolean
- `saved`: boolean (flash success message)

UI Layout (card-based, matching existing profile page style with bg-base-100 shadow-xl):

```
Card: "Weekly Availability"
  Card-body:
    // Timezone selector
    <div>
      <label>Your Timezone</label>
      <select> ... common timezones ... </select>
    </div>

    // Day-by-day availability
    For each day in [Monday, Tuesday, Wednesday, Thursday, Friday, Saturday, Sunday]:
      <div className="border-b py-3">
        <div className="flex items-center justify-between">
          <label className="font-medium capitalize">{day}</label>
          <button className="btn btn-xs btn-ghost" onClick={addRange(day)}>+ Add Time Range</button>
        </div>
        For each range in weekly[day]:
          <div className="flex items-center gap-2 mt-2">
            <input type="time" value={range.start} onChange={...} className="input input-bordered input-sm" />
            <span>to</span>
            <input type="time" value={range.end} onChange={...} className="input input-bordered input-sm" />
            <button className="btn btn-xs btn-error btn-ghost" onClick={removeRange(day, index)}>Remove</button>
          </div>
        If no ranges: <span className="text-sm opacity-60 ml-4">Not available</span>
      </div>

    // Save button
    <div className="mt-4 flex justify-end gap-2">
      {saved && <span className="text-success text-sm self-center">Saved!</span>}
      <button className="btn btn-primary" onClick={handleSave} disabled={saving}>
        {saving ? <span className="loading loading-spinner loading-sm"></span> : "Save Availability"}
      </button>
    </div>
```

For the timezone selector, provide a curated list of ~20 common IANA timezones rather than all 500+ (e.g., "America/New_York", "America/Chicago", "America/Denver", "America/Los_Angeles", "America/Anchorage", "Pacific/Honolulu", "Europe/London", "Europe/Paris", "Europe/Berlin", "Asia/Tokyo", "Asia/Shanghai", "Asia/Kolkata", "Asia/Dubai", "Australia/Sydney", "Pacific/Auckland", "America/Sao_Paulo", "America/Toronto", "Asia/Singapore", "Asia/Seoul", "Africa/Cairo"). Also detect and show user's local timezone at the top.

`handleSave` function:
1. Validate: for each day's ranges, verify start < end (compare HH:mm strings lexicographically works for 24h format)
2. Call `authFetch("/api/mentorship/availability", { method: "PUT", body: JSON.stringify({ availability: { weekly, timezone, slotDurationMinutes: 30 }, unavailableDates }) })`
3. Show success or error toast

Import `authFetch` from `@/lib/apiClient` for authenticated requests.
Import types from `@/types/mentorship`.
Use DaisyUI classes consistent with the profile page: `card bg-base-100 shadow-xl`, `card-body`, `btn`, `input`, etc.

**Create `src/components/mentorship/OverrideDatesManager.tsx`:**

A simpler "use client" component for managing unavailable date overrides.

Props:
```typescript
interface OverrideDatesManagerProps {
  dates: UnavailableDate[];
  onChange: (dates: UnavailableDate[]) => void;
}
```

UI (within a card section):
```
Card: "Unavailable Dates"
  Card-body:
    <p className="text-sm opacity-70 mb-3">Block specific dates when you won't be available.</p>

    // Add new date
    <div className="flex gap-2 mb-4">
      <input type="date" className="input input-bordered input-sm" min={today} />
      <input type="text" placeholder="Reason (optional)" className="input input-bordered input-sm flex-1" />
      <button className="btn btn-sm btn-primary">Add</button>
    </div>

    // List existing overrides
    For each override, sorted by date ascending:
      <div className="flex items-center justify-between py-1">
        <span>{formatted date}</span>
        <span className="text-sm opacity-60">{reason}</span>
        <button className="btn btn-xs btn-ghost text-error">Remove</button>
      </div>

    If no overrides: <p className="text-sm opacity-60">No override dates set.</p>
```

This component manages state locally and calls `onChange` with the updated array. The parent (profile page) handles the save.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify both components compile. Check that imports resolve correctly.
  </verify>
  <done>
AvailabilityManager provides a complete weekly schedule editor with timezone selection, day-by-day time range management, and save functionality. OverrideDatesManager provides add/remove interface for specific unavailable dates. Both use DaisyUI card-based styling matching the profile page.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate availability management and calendar connect into profile page</name>
  <files>src/app/profile/page.tsx</files>
  <action>
Update the existing profile page to include the availability management section for mentors and a Google Calendar connection button.

Read the current profile page fully first, then add the following:

**Add imports at the top:**
```typescript
import AvailabilityManager from "@/components/mentorship/AvailabilityManager";
import OverrideDatesManager from "@/components/mentorship/OverrideDatesManager";
import { TimeSlotAvailability, UnavailableDate } from "@/types/mentorship";
```

**Add state for availability data:**
```typescript
const [availability, setAvailability] = useState<TimeSlotAvailability | null>(null);
const [unavailableDates, setUnavailableDates] = useState<UnavailableDate[]>([]);
const [isCalendarConnected, setIsCalendarConnected] = useState(false);
const [calendarConnecting, setCalendarConnecting] = useState(false);
```

**Add useEffect to load availability data when profile loads:**
```typescript
useEffect(() => {
  if (profile?.uid) {
    fetch(`/api/mentorship/availability?mentorId=${profile.uid}`)
      .then(res => res.json())
      .then(data => {
        if (data.availability) setAvailability(data.availability);
        if (data.unavailableDates) setUnavailableDates(data.unavailableDates);
        // Calendar connection status is returned by the availability API (Plan 12-01)
        setIsCalendarConnected(!!data.googleCalendarConnected);
      })
      .catch(err => console.error("Failed to load availability:", err));
  }
}, [profile?.uid]);
```

Note: The `googleCalendarConnected` field is explicitly included in the GET /api/mentorship/availability response (see Plan 12-01). No separate API call or profile document fetch is needed.

**Check for calendar connection status from URL params** (after OAuth redirect):
```typescript
useEffect(() => {
  const params = new URLSearchParams(window.location.search);
  const calendarStatus = params.get("calendar");
  if (calendarStatus === "connected") {
    toast.success("Google Calendar connected successfully!");
    setIsCalendarConnected(true);
    // Clean URL
    window.history.replaceState({}, "", "/profile");
  } else if (calendarStatus === "error") {
    toast.error("Failed to connect Google Calendar. Please try again.");
    window.history.replaceState({}, "", "/profile");
  }
}, [toast]);
```

**Add Google Calendar connect handler:**
```typescript
const handleCalendarConnect = async () => {
  setCalendarConnecting(true);
  try {
    const res = await authFetch("/api/mentorship/calendar/auth");
    const data = await res.json();
    if (data.authUrl) {
      window.location.href = data.authUrl;
    } else {
      toast.error("Calendar integration not available");
    }
  } catch {
    toast.error("Failed to initiate calendar connection");
  } finally {
    setCalendarConnecting(false);
  }
};
```

**Add to the page JSX**, ONLY for users with role === "mentor", AFTER the existing profile content. Place inside a clearly separated section:

```jsx
{profile?.role === "mentor" && (
  <>
    {/* Availability Management Section */}
    <div className="divider text-lg font-semibold mt-8">Time Slot Availability</div>

    {/* Google Calendar Connection */}
    <div className="card bg-base-100 shadow-xl mb-6">
      <div className="card-body">
        <h3 className="card-title text-lg">Google Calendar Integration</h3>
        <p className="text-sm opacity-70">
          Connect your Google Calendar to automatically create events with Google Meet links when mentees book sessions.
        </p>
        <div className="mt-2">
          {isCalendarConnected ? (
            <div className="flex items-center gap-2 text-success">
              <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
              </svg>
              <span>Google Calendar connected</span>
            </div>
          ) : (
            <button
              className="btn btn-outline btn-sm"
              onClick={handleCalendarConnect}
              disabled={calendarConnecting}
            >
              {calendarConnecting ? (
                <span className="loading loading-spinner loading-sm"></span>
              ) : (
                "Connect Google Calendar"
              )}
            </button>
          )}
        </div>
      </div>
    </div>

    {/* Weekly Availability Editor */}
    <AvailabilityManager
      userId={profile.uid}
      initialAvailability={availability || undefined}
      initialUnavailableDates={unavailableDates}
      isCalendarConnected={isCalendarConnected}
    />

    {/* Override Dates */}
    <div className="mt-6">
      <OverrideDatesManager
        dates={unavailableDates}
        onChange={setUnavailableDates}
      />
    </div>
  </>
)}
```

Also add `authFetch` import: `import { authFetch } from "@/lib/apiClient";`

IMPORTANT: Also fetch the `googleCalendarConnected` field from the mentor profile to set initial `isCalendarConnected` state. Add this to the existing profile loading logic or the availability fetch. The simplest approach: add it to the availability API response (update the GET handler in availability/route.ts to also return `googleCalendarConnected: boolean`). If modifying the API, update it to include `googleCalendarConnected` in the response alongside availability and unavailableDates.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify compilation. Run `npm run build` to verify the page compiles. Manually verify the profile page renders without errors in dev mode. Verify data persistence: in dev mode, set some availability time ranges, save, hard-reload the page, and confirm the saved data loads back into the form correctly. Also verify `isCalendarConnected` is read from the availability API response (not left as a TODO).
  </verify>
  <done>
Profile page shows availability management section for mentors including: Google Calendar connect button with status indicator (read from availability API), weekly availability editor with timezone and time ranges per day, and override dates manager. Availability data loads on page mount and persists via API. Calendar OAuth redirects are handled via URL params. Saved settings reload correctly after page refresh.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds
3. Profile page renders AvailabilityManager for mentor role users
4. Google Calendar connect button initiates OAuth flow
5. Weekly availability saves via PUT /api/mentorship/availability
6. Override dates can be added and removed
7. **Data persistence check:** After saving availability, reload the profile page and verify the saved availability data (weekly time ranges, timezone, and unavailable dates) is loaded back into the form from the GET /api/mentorship/availability response. Confirm that the form fields display the previously saved values, not defaults.
</verification>

<success_criteria>
- Mentor sees availability management section on profile page
- Weekly schedule editor allows adding/removing time ranges per day
- Timezone selector defaults to browser timezone
- Override dates can be added with optional reason and removed
- Google Calendar connection button triggers OAuth flow
- Save button persists availability to Firestore via API
- Card-based styling matches existing profile page (bg-base-100 shadow-xl)
</success_criteria>

<output>
After completion, create `.planning/phases/12-mentor-time-slots-weekly-availability-management-mentee-booking-rescheduling-google-calendar-integration/12-04-SUMMARY.md`
</output>
