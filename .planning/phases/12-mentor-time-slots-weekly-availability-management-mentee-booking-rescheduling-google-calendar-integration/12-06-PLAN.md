---
phase: 12-mentor-time-slots-weekly-availability-management-mentee-booking-rescheduling-google-calendar-integration
plan: 06
type: execute
wave: 4
depends_on: ["12-02", "12-03", "12-04", "12-05"]
files_modified:
  - src/app/api/mentorship/bookings/route.ts
  - src/app/profile/page.tsx
  - src/components/mentorship/BookingsList.tsx
autonomous: false

must_haves:
  truths:
    - "Booking creation triggers Google Calendar event creation with Google Meet link (if calendar connected)"
    - "Booking cancellation triggers Google Calendar event deletion (if event was created)"
    - "Calendar sync failures do not block booking operations"
    - "Mentor can see their booked sessions on profile page"
    - "Booking page is accessible from mentor profile via Book Session link"
  artifacts:
    - path: "src/app/api/mentorship/bookings/route.ts"
      provides: "Booking API with calendar integration wired in"
      contains: "createCalendarEvent"
    - path: "src/app/profile/page.tsx"
      provides: "Profile page with BookingsList for mentors"
      contains: "BookingsList"
  key_links:
    - from: "src/app/api/mentorship/bookings/route.ts"
      to: "src/lib/google-calendar.ts"
      via: "creates/deletes calendar events after booking mutations"
      pattern: "createCalendarEvent|deleteCalendarEvent"
---

<objective>
Wire Google Calendar event creation into the booking flow, calendar event deletion into the cancel flow, add BookingsList to the mentor profile page, and verify the complete end-to-end workflow.

Purpose: Complete the integration between all components so the full user journey works: mentor sets availability -> mentee books -> calendar event created -> mentor cancels -> calendar event deleted -> Discord DM sent.
Output: Updated bookings API with calendar integration, updated profile page with bookings, human verification of the complete flow.
</objective>

<execution_context>
@/home/ahsan/.claude/get-shit-done/workflows/execute-plan.md
@/home/ahsan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-mentor-time-slots-weekly-availability-management-mentee-booking-rescheduling-google-calendar-integration/12-02-SUMMARY.md
@.planning/phases/12-mentor-time-slots-weekly-availability-management-mentee-booking-rescheduling-google-calendar-integration/12-03-SUMMARY.md
@.planning/phases/12-mentor-time-slots-weekly-availability-management-mentee-booking-rescheduling-google-calendar-integration/12-04-SUMMARY.md
@.planning/phases/12-mentor-time-slots-weekly-availability-management-mentee-booking-rescheduling-google-calendar-integration/12-05-SUMMARY.md
@src/app/api/mentorship/bookings/route.ts
@src/lib/google-calendar.ts
@src/app/profile/page.tsx
@src/components/mentorship/BookingsList.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire Google Calendar integration into booking create and cancel flows</name>
  <files>src/app/api/mentorship/bookings/route.ts, src/app/profile/page.tsx, src/components/mentorship/BookingsList.tsx</files>
  <action>
**Update `src/app/api/mentorship/bookings/route.ts`:**

Add imports at the top:
```typescript
import { createCalendarEvent, deleteCalendarEvent, isCalendarConfigured } from "@/lib/google-calendar";
```

**In the POST handler (after successful booking creation):**

After the Firestore transaction succeeds and the booking is created, add non-blocking calendar event creation:

```typescript
// After booking created successfully, attempt calendar event creation (non-blocking)
if (isCalendarConfigured()) {
  try {
    const eventId = await createCalendarEvent(mentorId, {
      id: bookingId,
      startTime: startTimeDate,
      endTime: endTimeDate,
      timezone,
      menteeName: menteeProfile.displayName,
      menteeEmail: menteeProfile.email,
    });

    if (eventId) {
      // Update booking with calendar event ID
      await db.collection("mentorship_bookings").doc(bookingId).update({
        calendarEventId: eventId,
        calendarSyncStatus: "synced",
      });
    } else {
      await db.collection("mentorship_bookings").doc(bookingId).update({
        calendarSyncStatus: "not_connected",
      });
    }
  } catch (calendarError) {
    console.error("Calendar event creation failed (non-blocking):", calendarError);
    await db.collection("mentorship_bookings").doc(bookingId).update({
      calendarSyncStatus: "failed",
    }).catch(() => {}); // Double catch: don't fail if update fails too
  }
}
```

This follows the exact same non-blocking pattern used for Discord notifications in the existing scheduled-sessions route.

**In the PUT handler (cancel action):**

After updating the booking status to cancelled and sending Discord DM, add calendar event deletion:

```typescript
// After booking cancelled, attempt calendar event deletion (non-blocking)
if (isCalendarConfigured() && bookingData.calendarEventId) {
  try {
    await deleteCalendarEvent(bookingData.mentorId, bookingData.calendarEventId);
    // Update booking to clear calendar reference
    await db.collection("mentorship_bookings").doc(bookingId).update({
      calendarSyncStatus: "cancelled",
    });
  } catch (calendarError) {
    console.error("Calendar event deletion failed (non-blocking):", calendarError);
    // Don't fail the cancel operation
  }
}
```

**Update `src/app/profile/page.tsx`:**

Add BookingsList import and render it in the mentor's availability section:
```typescript
import BookingsList from "@/components/mentorship/BookingsList";
```

Add after the OverrideDatesManager in the mentor availability section:
```jsx
{/* Upcoming Bookings */}
<div className="mt-6">
  <BookingsList userId={profile.uid} role="mentor" />
</div>
```

This shows mentors their booked sessions right below their availability settings.

**Update `src/components/mentorship/BookingsList.tsx`:**

Add a "Book Session" link for mentees viewing the list, if they have no upcoming bookings, suggesting they browse mentors. Also add calendar sync status indicator if available:

For each booking that has `calendarSyncStatus === "synced"`, show a small calendar icon. For `failed`, show a warning icon.

```jsx
{booking.calendarSyncStatus === "synced" && (
  <span className="badge badge-success badge-xs" title="Google Calendar event created">Cal</span>
)}
{booking.calendarSyncStatus === "failed" && (
  <span className="badge badge-warning badge-xs" title="Calendar sync failed">!</span>
)}
```
  </action>
  <verify>
Run `npx tsc --noEmit` to verify compilation. Run `npm run build` to verify all routes and pages compile. Check that the bookings API route imports resolve correctly.
  </verify>
  <done>
Booking creation attempts Google Calendar event creation (non-blocking, following Discord pattern). Booking cancellation deletes Google Calendar event (non-blocking). Profile page shows BookingsList for mentors. Calendar sync status is indicated on bookings. All calendar failures are logged but don't block the booking flow.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify complete mentor time slots flow</name>
  <files>n/a</files>
  <action>
Human verification of the complete mentor time slot booking system:
1. Mentor availability management (weekly schedule, override dates, timezone)
2. Mentee booking interface (date navigator, slot grid, booking confirmation)
3. Booking management (view, cancel with Discord DM)
4. Google Calendar integration (OAuth connect, event creation with Meet link, event deletion)
5. BookingsList on profile page for mentors

**Mentor Flow:**
1. Log in as a mentor
2. Navigate to /profile
3. Scroll to "Time Slot Availability" section
4. Set timezone, add time ranges for at least 2 days
5. Save availability - verify success message
6. Add an override date - verify it appears in the list
7. (If Google Calendar env vars configured) Click "Connect Google Calendar" - verify OAuth flow redirects and returns with success
8. Verify "Mentee Bookings" section appears (empty initially)

**Mentee Flow:**
1. Log in as a mentee
2. Navigate to /mentorship/book/{mentor-uid}
3. Verify mentor info header displays correctly
4. Navigate dates - verify available slots appear for days the mentor set
5. Select a slot - verify confirmation panel shows
6. Confirm booking - verify success message
7. Verify the booked slot disappears from available slots
8. Verify the booking appears in BookingsList below

**Cancel Flow:**
1. As mentor, go to /profile
2. Find the booking in "Mentee Bookings"
3. Click Cancel - confirm
4. Verify booking shows as cancelled
5. (If Discord configured) Verify mentee receives Discord DM about cancellation

**Edge Cases:**
- Try booking a slot that's already booked (should get 409 error)
- Try booking a slot less than 2 hours in the future (should be filtered out)
- Try booking your own slots (should see "cannot book yourself" message)
  </action>
  <verify>Human manually tests all flows described above and reports pass/fail.</verify>
  <done>All mentor, mentee, and cancel flows work correctly. Edge cases handled. Type "approved" or describe issues found.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds
3. Complete flow verified by human tester
4. Calendar events created/deleted correctly (when configured)
5. Discord DMs sent on cancellation (when configured)
6. Double-booking prevention works under concurrent access
</verification>

<success_criteria>
- Full mentor flow: set availability -> save -> see bookings
- Full mentee flow: browse dates -> select slot -> book -> see confirmation
- Cancel flow: cancel booking -> Discord DM sent -> calendar event deleted
- Calendar integration is non-blocking (failures logged, not thrown)
- All edge cases handled (self-booking, past slots, conflicts)
- Build passes with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/12-mentor-time-slots-weekly-availability-management-mentee-booking-rescheduling-google-calendar-integration/12-06-SUMMARY.md`
</output>
