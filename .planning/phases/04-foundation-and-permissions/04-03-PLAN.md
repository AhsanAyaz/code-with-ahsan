---
phase: 04-foundation-and-permissions
plan: 03
type: tdd
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/lib/permissions.ts
  - src/__tests__/permissions.test.ts
autonomous: true

must_haves:
  truths:
    - "canCreateProject returns true only for accepted mentors"
    - "canCreateRoadmap returns true only for accepted mentors"
    - "canApproveProject and canApproveRoadmap return true only for admins"
    - "canManageProjectMembers returns true for project owner and admins"
    - "canApplyToProject returns false for project creator (self-application blocked)"
    - "canApplyToProject returns true for any authenticated user who is not the creator"
    - "All permission functions return false for unauthenticated/null users"
  artifacts:
    - path: "src/lib/permissions.ts"
      provides: "Centralized permission system with action-based checks"
      exports: ["canCreateProject", "canCreateRoadmap", "canApproveProject", "canApproveRoadmap", "canEditProject", "canManageProjectMembers", "canApplyToProject", "canEditRoadmap"]
    - path: "src/__tests__/permissions.test.ts"
      provides: "Unit tests covering all role combinations for all permission actions"
      contains: "describe.*Permission"
  key_links:
    - from: "src/lib/permissions.ts"
      to: "src/types/mentorship.ts"
      via: "imports Project, Roadmap, MentorshipProfile types"
      pattern: "from.*@/types/mentorship"
    - from: "src/__tests__/permissions.test.ts"
      to: "src/lib/permissions.ts"
      via: "imports all permission functions"
      pattern: "from.*@/lib/permissions"
---

<objective>
Build the centralized permission system using TDD (test-driven development). Write comprehensive tests first for all PERM requirements, then implement the permission functions to make tests pass.

Purpose: The permission system is the single source of truth for authorization logic. It must correctly enforce PERM-01 through PERM-08 across all role combinations (admin, accepted mentor, pending mentor, mentee, unauthenticated). TDD ensures every permission edge case is covered before implementation.
Output: Tested permission module at src/lib/permissions.ts
</objective>

<execution_context>
@/Users/amu1o5/.claude/get-shit-done/workflows/execute-plan.md
@/Users/amu1o5/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-foundation-and-permissions/04-RESEARCH.md
@.planning/phases/04-foundation-and-permissions/04-01-SUMMARY.md
@src/types/mentorship.ts
</context>

<feature>
  <name>Centralized Permission System</name>
  <files>src/lib/permissions.ts, src/__tests__/permissions.test.ts</files>
  <behavior>
    Permission functions take a user context (MentorshipProfile or null) and optionally a resource (Project/Roadmap), returning boolean.

    Test matrix (all combinations must be covered):

    | Function | Admin | Accepted Mentor (owner) | Accepted Mentor (non-owner) | Pending Mentor | Mentee | Null |
    |----------|-------|------------------------|-----------------------------|----------------|--------|------|
    | canCreateProject | true | true | true | false | false | false |
    | canCreateRoadmap | true | true | false | false | false | false |
    | canApproveProject | true | false | false | false | false | false |
    | canApproveRoadmap | true | false | false | false | false | false |
    | canEditProject (owner) | true | true | false | false | false | false |
    | canEditProject (non-owner) | true | false | false | false | false | false |
    | canManageProjectMembers | true | true (owner) | false | false | false | false |
    | canApplyToProject (own) | false | false | false | false | false | false |
    | canApplyToProject (other) | true | true | true | true | true | false |

    Key behaviors:
    - PERM-01: canCreateProject - accepted mentors only (admin is also accepted mentor OR has admin flag)
    - PERM-02: canCreateRoadmap - accepted mentors only (no project ownership requirement at this layer -- that is enforced at DAL level)
    - PERM-03: canApproveProject/canApproveRoadmap - admins only (checked via isAdmin flag on user)
    - PERM-04: canManageProjectMembers - project creator OR admin
    - PERM-07: canApplyToProject - any authenticated user
    - PERM-08: canApplyToProject - NOT the project creator

    Admin detection: Use an `isAdmin` boolean field on the user context object. In the real app, this maps to `request.auth.token.admin == true` custom claim. The permission system takes it as input, does not look it up.

    Interface for user context:
    ```typescript
    interface PermissionUser {
      uid: string;
      role: MentorshipRole;
      status?: "pending" | "accepted" | "declined" | "disabled";
      isAdmin?: boolean;
    }
    ```

    This is a subset of MentorshipProfile. Permission functions accept `PermissionUser | null` to handle unauthenticated cases.
  </behavior>
  <implementation>
    1. RED: Create `src/__tests__/permissions.test.ts` with all test cases from the matrix above.
       - Create test fixtures: acceptedMentor, pendingMentor, mentee, admin, nullUser
       - Create test project fixture owned by acceptedMentor
       - Write describe blocks for each permission function
       - Write individual test cases for each role combination
       - Tests import from `@/lib/permissions` (file doesn't exist yet -- tests will fail)
       - Run `npx vitest run` -- all tests MUST fail
       - Commit: `test(04-03): add failing tests for permission system`

    2. GREEN: Create `src/lib/permissions.ts` implementing all permission functions.
       - Export `PermissionUser` type
       - Export `ProjectAction` and `RoadmapAction` enums for type-safe action references
       - Implement helper: `isAcceptedMentor(user)` -- checks role === "mentor" && status === "accepted"
       - Implement helper: `isAdminUser(user)` -- checks user.isAdmin === true
       - Implement each `can*` function per the behavior spec above
       - Run `npx vitest run` -- all tests MUST pass
       - Commit: `feat(04-03): implement centralized permission system`

    3. REFACTOR (if needed): Clean up any redundancy.
       - Run `npx vitest run` -- tests MUST still pass
       - Commit only if changes made: `refactor(04-03): clean up permission functions`

    IMPORTANT: Permission functions should be synchronous (not async). There is no database lookup needed -- all inputs are provided by the caller. This makes testing simpler and execution faster.
  </implementation>
</feature>

<verification>
1. `npx vitest run src/__tests__/permissions.test.ts` passes with 0 failures
2. All 8 permission functions exported from `src/lib/permissions.ts`
3. Test file covers all role combinations from the matrix (minimum 25+ test cases)
4. `npx tsc --noEmit` passes
</verification>

<success_criteria>
- Every PERM requirement (01-04, 07-08) has corresponding test cases
- All tests pass
- Permission functions are synchronous and type-safe
- PermissionUser type exported for use by DAL and Server Actions
- Zero external dependencies (pure TypeScript logic)
</success_criteria>

<output>
After completion, create `.planning/phases/04-foundation-and-permissions/04-03-SUMMARY.md`
</output>
