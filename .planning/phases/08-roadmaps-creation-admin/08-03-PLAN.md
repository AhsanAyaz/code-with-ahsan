---
phase: 08-roadmaps-creation-admin
plan: 03
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/app/mentorship/admin/page.tsx
  - src/app/roadmaps/[id]/edit/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin dashboard has a Roadmaps tab showing pending roadmap submissions"
    - "Admin can approve a roadmap from the Roadmaps tab"
    - "Admin can request changes on a roadmap with required feedback text"
    - "Roadmap cards show title, creator, domain, difficulty, estimated hours, and a content preview link"
    - "Mentor can edit a published or draft roadmap at /roadmaps/[id]/edit creating a new version"
    - "Edit page loads existing roadmap content into MDEditor for modification"
  artifacts:
    - path: "src/app/mentorship/admin/page.tsx"
      provides: "Roadmaps tab in admin dashboard with approve/request-changes workflow"
      contains: "roadmaps"
    - path: "src/app/roadmaps/[id]/edit/page.tsx"
      provides: "Roadmap edit page with MDEditor pre-populated with existing content"
      contains: "MDEditor"
  key_links:
    - from: "src/app/mentorship/admin/page.tsx"
      to: "/api/roadmaps"
      via: "fetch GET for pending roadmaps list"
      pattern: "api/roadmaps.*status=pending"
    - from: "src/app/mentorship/admin/page.tsx"
      to: "/api/roadmaps/[id]"
      via: "authFetch PUT for approve/request-changes actions"
      pattern: "authFetch.*api/roadmaps"
    - from: "src/app/roadmaps/[id]/edit/page.tsx"
      to: "/api/roadmaps/[id]"
      via: "fetch GET for existing content, authFetch PUT for edit action"
      pattern: "api/roadmaps"
---

<objective>
Add Roadmaps tab to the admin dashboard for reviewing/approving roadmap submissions, and create the roadmap edit page for mentors to update their published or draft roadmaps with version history.

Purpose: Completes the admin approval workflow (approve/request changes) and enables the roadmap editing loop that creates new versions. Together with Plan 01 (API) and Plan 02 (creation form), this delivers the full roadmap lifecycle.
Output: Admin dashboard Roadmaps tab and roadmap edit page at /roadmaps/[id]/edit.
</objective>

<execution_context>
@/Users/amu1o5/.claude/get-shit-done/workflows/execute-plan.md
@/Users/amu1o5/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-roadmaps-creation-admin/08-RESEARCH.md
@.planning/phases/08-roadmaps-creation-admin/08-01-PLAN.md

# Key references for implementation patterns
@src/app/mentorship/admin/page.tsx
@src/app/projects/new/page.tsx
@src/lib/apiClient.ts
@src/types/mentorship.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Roadmaps tab to admin dashboard with approve/request-changes workflow</name>
  <files>src/app/mentorship/admin/page.tsx</files>
  <action>
Extend the existing admin dashboard page to add a "Roadmaps" tab following the exact pattern used for the "Projects" tab. This is a modification to an existing large file (~2700 lines), so be surgical and follow existing patterns precisely.

**Step 1: Extend TabType union and add state variables**

Find `type TabType = "overview" | "pending-mentors" | "all-mentors" | "all-mentees" | "projects";` and add `"roadmaps"`:
```typescript
type TabType = "overview" | "pending-mentors" | "all-mentors" | "all-mentees" | "projects" | "roadmaps";
```

Add new state variables near the existing project state variables (around line 100-110):
```typescript
// Roadmap state (follows projects pattern)
const [roadmaps, setRoadmaps] = useState<Roadmap[]>([]);
const [loadingRoadmaps, setLoadingRoadmaps] = useState(false);
const [roadmapActionLoading, setRoadmapActionLoading] = useState<string | null>(null);
const [feedbackRoadmapId, setFeedbackRoadmapId] = useState<string | null>(null);
const [feedbackText, setFeedbackText] = useState("");
```

Add `Roadmap` to the type imports from `@/types/mentorship`:
```typescript
import type { ..., Roadmap } from "@/types/mentorship";
```

**Step 2: Add roadmaps fetch effect**

Add a new useEffect following the exact pattern of the projects fetch effect (around line 297-319):
```typescript
// Fetch roadmaps when roadmaps tab is active
useEffect(() => {
  const fetchRoadmaps = async () => {
    if (activeTab !== "roadmaps") return;

    setLoadingRoadmaps(true);
    try {
      const response = await fetch("/api/roadmaps?status=pending");
      if (response.ok) {
        const data = await response.json();
        setRoadmaps(data.roadmaps || []);
      }
    } catch (error) {
      console.error("Error fetching roadmaps:", error);
    } finally {
      setLoadingRoadmaps(false);
    }
  };

  if (isAdminAuthenticated) {
    fetchRoadmaps();
  }
}, [isAdminAuthenticated, activeTab]);
```

**Step 3: Add handler functions**

Add after the existing `confirmDeclineProject` function (around line 681):

```typescript
const handleApproveRoadmap = async (roadmapId: string) => {
  if (!user) return;
  setRoadmapActionLoading(roadmapId);
  try {
    const response = await authFetch(`/api/roadmaps/${roadmapId}`, {
      method: "PUT",
      body: JSON.stringify({ action: "approve" })
    });

    if (!response.ok) {
      const data = await response.json();
      throw new Error(data.error || "Failed to approve roadmap");
    }

    toast.success("Roadmap approved and published!");
    setRoadmaps(prev => prev.filter(r => r.id !== roadmapId));
  } catch (error) {
    toast.error(error instanceof Error ? error.message : "Failed to approve roadmap");
  } finally {
    setRoadmapActionLoading(null);
  }
};

const handleRequestChangesRoadmap = (roadmapId: string) => {
  setFeedbackRoadmapId(roadmapId);
  setFeedbackText("");
};

const confirmRequestChanges = async () => {
  if (!feedbackRoadmapId || !user) return;
  if (feedbackText.trim().length < 10) {
    toast.error("Feedback must be at least 10 characters");
    return;
  }
  setRoadmapActionLoading(feedbackRoadmapId);
  try {
    const response = await authFetch(`/api/roadmaps/${feedbackRoadmapId}`, {
      method: "PUT",
      body: JSON.stringify({
        action: "request-changes",
        feedback: feedbackText.trim()
      })
    });

    if (!response.ok) {
      const data = await response.json();
      throw new Error(data.error || "Failed to request changes");
    }

    toast.success("Changes requested. Mentor will be notified.");
    setRoadmaps(prev => prev.filter(r => r.id !== feedbackRoadmapId));
    setFeedbackRoadmapId(null);
    setFeedbackText("");
  } catch (error) {
    toast.error(error instanceof Error ? error.message : "Failed to request changes");
  } finally {
    setRoadmapActionLoading(null);
  }
};
```

**Step 4: Add Roadmaps tab button**

Find the projects tab button (around line 906-907) and add a roadmaps tab after it:
```html
<a
  className={`tab ${activeTab === "roadmaps" ? "tab-active" : ""}`}
  onClick={() => setActiveTab("roadmaps")}
>
  Roadmaps
</a>
```

**Step 5: Add Roadmaps tab content**

Add AFTER the projects tab content block (after the closing `)}` of `{activeTab === "projects" && (...)}`), BEFORE the `{/* Alerts Modal */}` comment:

```jsx
{activeTab === "roadmaps" && (
  <div className="space-y-4">
    {loadingRoadmaps ? (
      <div className="flex justify-center items-center py-12">
        <span className="loading loading-spinner loading-lg"></span>
      </div>
    ) : roadmaps.length === 0 ? (
      <div className="text-center py-12 text-base-content/60">
        No pending roadmap submissions
      </div>
    ) : (
      <div className="grid gap-4">
        {roadmaps.map((roadmap) => (
          <div key={roadmap.id} className="card bg-base-200 shadow-md">
            <div className="card-body">
              <h3 className="card-title">{roadmap.title}</h3>
              {roadmap.description && (
                <p className="text-sm text-base-content/80">
                  {roadmap.description.length > 200
                    ? `${roadmap.description.substring(0, 200)}...`
                    : roadmap.description}
                </p>
              )}
              <div className="mt-2 space-y-2 text-sm">
                <div>
                  <span className="font-semibold">Author:</span>{" "}
                  {roadmap.creatorProfile?.displayName || "Unknown"}
                </div>
                <div>
                  <span className="font-semibold">Domain:</span>{" "}
                  <span className="badge badge-sm badge-outline">
                    {roadmap.domain}
                  </span>
                </div>
                <div>
                  <span className="font-semibold">Difficulty:</span>{" "}
                  <span className={`badge badge-sm ${
                    roadmap.difficulty === "beginner"
                      ? "badge-success"
                      : roadmap.difficulty === "intermediate"
                      ? "badge-warning"
                      : "badge-error"
                  }`}>
                    {roadmap.difficulty}
                  </span>
                </div>
                {roadmap.estimatedHours && (
                  <div>
                    <span className="font-semibold">Estimated:</span>{" "}
                    {roadmap.estimatedHours} hours
                  </div>
                )}
                <div>
                  <span className="font-semibold">Version:</span>{" "}
                  {roadmap.version}
                </div>
                <div className="text-xs text-base-content/60">
                  Submitted: {roadmap.createdAt ? format(new Date(roadmap.createdAt as unknown as string), "MMM d, yyyy") : "Unknown"}
                </div>
              </div>
              <div className="card-actions justify-end mt-4">
                <button
                  className="btn btn-success btn-sm"
                  onClick={() => handleApproveRoadmap(roadmap.id)}
                  disabled={roadmapActionLoading === roadmap.id}
                >
                  {roadmapActionLoading === roadmap.id ? (
                    <>
                      <span className="loading loading-spinner loading-xs"></span>
                      Approving...
                    </>
                  ) : (
                    "Approve"
                  )}
                </button>
                <button
                  className="btn btn-warning btn-sm"
                  onClick={() => handleRequestChangesRoadmap(roadmap.id)}
                  disabled={roadmapActionLoading === roadmap.id}
                >
                  Request Changes
                </button>
              </div>
            </div>
          </div>
        ))}
      </div>
    )}
  </div>
)}
```

**Step 6: Add feedback modal for request changes**

Add a dialog modal for the feedback input, following the pattern of the project decline reason modal. Place it near the existing alerts modal at the end of the component:

```jsx
{/* Roadmap Feedback Modal */}
<dialog className={`modal ${feedbackRoadmapId ? "modal-open" : ""}`}>
  <div className="modal-box">
    <h3 className="font-bold text-lg">Request Changes</h3>
    <p className="py-2 text-sm text-base-content/70">
      Provide feedback explaining what changes are needed before this roadmap can be approved.
    </p>
    <div className="form-control">
      <textarea
        className="textarea textarea-bordered w-full"
        placeholder="Explain what changes are needed (minimum 10 characters)..."
        value={feedbackText}
        onChange={(e) => setFeedbackText(e.target.value)}
        rows={4}
      />
      <label className="label">
        <span className="label-text-alt">{feedbackText.length} characters (min 10)</span>
      </label>
    </div>
    <div className="modal-action">
      <button
        className="btn btn-ghost"
        onClick={() => { setFeedbackRoadmapId(null); setFeedbackText(""); }}
      >
        Cancel
      </button>
      <button
        className="btn btn-warning"
        onClick={confirmRequestChanges}
        disabled={feedbackText.trim().length < 10 || roadmapActionLoading === feedbackRoadmapId}
      >
        {roadmapActionLoading === feedbackRoadmapId ? (
          <>
            <span className="loading loading-spinner loading-xs"></span>
            Sending...
          </>
        ) : (
          "Send Feedback"
        )}
      </button>
    </div>
  </div>
  <form method="dialog" className="modal-backdrop">
    <button onClick={() => { setFeedbackRoadmapId(null); setFeedbackText(""); }}>close</button>
  </form>
</dialog>
```

**Step 7: Update the overview tab fetch skip condition**

Find the useEffect that skips fetching for overview and projects tabs (around line 267):
```typescript
if (activeTab === "overview" || activeTab === "projects") return;
```
Update to also skip roadmaps:
```typescript
if (activeTab === "overview" || activeTab === "projects" || activeTab === "roadmaps") return;
```

**Important notes:**
- Use `authFetch` (imported from `@/lib/apiClient`) for PUT requests since they require authentication
- Use plain `fetch` for GET requests to the public listing endpoint (same as projects pattern)
- The `format` function from `date-fns` is already imported in this file
- The `toast` object from `useToast()` is already available
- Do NOT import `Roadmap` from the full path; it's already in `@/types/mentorship` alongside existing imports
  </action>
  <verify>
Run `npm run build` to verify no build errors.
Verify the Roadmaps tab appears in the admin dashboard tab bar.
Verify TypeScript compiles: `npx tsc --noEmit`.
  </verify>
  <done>
Admin dashboard has Roadmaps tab showing pending submissions.
Admin can approve roadmaps (changes status to approved).
Admin can request changes with required feedback (changes status back to draft with feedback).
Roadmap cards display title, author, domain, difficulty, estimated hours, version, and date.
Feedback modal requires minimum 10 character explanation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create roadmap edit page with MDEditor and version tracking</name>
  <files>src/app/roadmaps/[id]/edit/page.tsx</files>
  <action>
Create `src/app/roadmaps/[id]/edit/page.tsx` for editing existing roadmaps. This page loads the current roadmap content and allows the mentor to modify it, creating a new version.

**File structure:**
```
"use client";
// imports
export const dynamic = 'force-dynamic';
// interfaces
// page component
```

**Imports:**
- `useState, useEffect, useActionState` from "react"
- `useMentorship` from "@/contexts/MentorshipContext"
- `useRouter, useParams` from "next/navigation"
- `Link` from "next/link"
- `authFetch` from "@/lib/apiClient"
- `dynamic` from "next/dynamic" - for MDEditor: `const MDEditor = dynamic(() => import("@uiw/react-md-editor"), { ssr: false });`
- Types: `RoadmapDomain, ProjectDifficulty, Roadmap` from "@/types/mentorship"

**Same DOMAIN_OPTIONS and DIFFICULTY_OPTIONS constants as in 08-02 plan (roadmaps/new/page.tsx).**

**Component logic:**

1. Get `params` via `useParams()`, extract `id` as string
2. State: `roadmap` (Roadmap | null), `loadingRoadmap` (boolean), `loadError` (string | null)
3. Controlled form state: `title`, `description`, `domain`, `difficulty`, `estimatedHours`, `content`, `changeDescription` (string for version changelog)
4. useEffect to fetch roadmap on mount:
   ```
   fetch(`/api/roadmaps/${id}`)
   → parse JSON
   → set roadmap state
   → populate form fields from response data
   → set content from response.roadmap.content (fetched from Storage by API)
   ```
5. Auth gate: same as creation page - must be authenticated, must be roadmap creator or admin
6. Show feedback banner if `roadmap.feedback` exists: "Admin feedback: {feedback}" in alert-warning

**Form action `editRoadmapAction(prevState, formData)`:**
1. Validate: title 3-100 chars, content 50+ chars (same rules as creation)
2. PUT to `/api/roadmaps/${id}` via authFetch with:
   ```json
   {
     "action": "edit",
     "title": title,
     "description": description,
     "domain": domain,
     "difficulty": difficulty,
     "estimatedHours": parsed number or undefined,
     "content": content,
     "changeDescription": changeDescription || undefined
   }
   ```
3. On success, return `{ success: true, version: data.version }`
4. Handle errors

**Form layout:**
Similar to creation form but:
- Page title: "Edit Roadmap"
- Pre-populated fields from loaded roadmap data
- Additional field: "Change Description" textarea (optional, max 200 chars, "Briefly describe what changed in this version")
- Single submit button: "Save Changes" (not dual draft/submit - editing always saves as draft, requiring re-approval)
- Show current version number: "Currently editing version {roadmap.version}"
- Disable form while roadmap is loading

**Loading state:** Show skeleton/spinner while fetching roadmap.
**Error state:** If fetch fails or roadmap not found, show error with link back.
**Success state:** "Roadmap updated to version {version}! It has been returned to draft status for re-review." with link options.

**Permission check:** After loading roadmap, verify `user.uid === roadmap.creatorId` OR user is admin. If neither, show "You don't have permission to edit this roadmap."

Use same DaisyUI form classes and patterns as the creation page.
  </action>
  <verify>
Run `npm run build` to verify no build errors.
Verify the edit page loads roadmap data and pre-populates the MDEditor.
Verify TypeScript compiles: `npx tsc --noEmit`.
  </verify>
  <done>
Edit page at /roadmaps/[id]/edit loads existing roadmap content into MDEditor.
Saving creates a new version (version number increments) and resets status to draft.
Change description field allows mentor to document what changed.
Admin feedback is displayed if present.
Permission check ensures only creator or admin can edit.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds without errors
2. Admin dashboard shows 6 tabs: Overview, Pending Mentors, All Mentors, All Mentees, Projects, Roadmaps
3. Roadmaps tab fetches and displays pending roadmap submissions
4. Approve button calls PUT /api/roadmaps/[id] with action "approve" and removes card from list
5. Request Changes opens feedback modal, sends PUT with action "request-changes" and feedback text
6. /roadmaps/[id]/edit loads existing roadmap content into MDEditor
7. Saving edit creates new version via PUT with action "edit"
8. Both admin actions and edit page use authFetch for authenticated requests
</verification>

<success_criteria>
- Admin can view pending roadmap submissions in the Roadmaps tab
- Admin can approve roadmaps to publish them
- Admin can request changes with mandatory feedback
- Mentor can edit published or draft roadmaps at /roadmaps/[id]/edit
- Edit creates a new version with incremented version number
- Edit resets roadmap status to draft for re-review
- Admin feedback displayed to mentor on edit page
- All permission checks enforced (admin for approve/decline, owner/admin for edit)
</success_criteria>

<output>
After completion, create `.planning/phases/08-roadmaps-creation-admin/08-03-SUMMARY.md`
</output>
